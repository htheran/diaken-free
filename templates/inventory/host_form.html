{% extends 'base/base.html' %}
{% load i18n %}
{% block title %}{% trans "Host" %}{% endblock %}
{% block content %}
  <div class="container mt-4">
    <div class="card">
      <div class="card-header">
        <h2>{% if form.instance.pk %}Edit{% else %}Create{% endif %} Host</h2>
      </div>
      <div class="card-body">
        <!-- Django Messages -->
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' or message.tags == 'danger' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
              {{ message }}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          {% endfor %}
        {% endif %}
        {% if form.non_field_errors %}
  <div class="alert alert-danger">
    {{ form.non_field_errors }}
  </div>
{% endif %}
<div class="alert alert-warning"><pre>{{ form.errors }}</pre></div>
<form method="post">
  {% csrf_token %}
  <div class="form-group">
    <label for="id_environment">Environment:</label>
    <select name="environment" class="form-control" id="id_environment">
      <option value="">-------------</option>
      {% for env in form.fields.environment.queryset %}
        <option value="{{ env.pk }}" {% if form.initial.environment == env.pk %}selected{% endif %}>{{ env.name }}</option>
      {% endfor %}
    </select>
    {% if form.environment.errors %}
      <div class="text-danger">{{ form.environment.errors }}</div>
    {% endif %}
  </div>
          <div class="form-group">
            <label for="id_group">Group:</label>
            <select name="group" class="form-control" id="id_group">
              <option value="">-------------</option>
              {% for grp in form.fields.group.queryset %}
                <option value="{{ grp.pk }}" data-environment-id="{{ grp.environment.pk }}" {% if form.initial.group == grp.pk %}selected{% endif %}>{{ grp.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="id_name">Name:</label>
            <input type="text" name="name" class="form-control" id="id_name" value="{{ form.name.value|default:'' }}">
{% if form.name.errors %}<div class="text-danger">{{ form.name.errors }}</div>{% endif %}
          </div>
          <div class="form-group">
            <label for="id_ip">IP Address:</label>
            <input type="text" name="ip" class="form-control" id="id_ip" value="{{ form.ip.value|default:'' }}">
{% if form.ip.errors %}<div class="text-danger">{{ form.ip.errors }}</div>{% endif %}
          </div>
          <div class="form-group">
            <label for="id_vcenter_server">vCenter Server:</label>
            <select name="vcenter_server" class="form-control" id="id_vcenter_server">
              <option value="">-------------</option>
              {% for vcenter in vcenters %}
                <option value="{{ vcenter.host }}" {% if form.vcenter_server.value == vcenter.host %}selected{% endif %}>
                  {{ vcenter.name }} ({{ vcenter.host }})
                </option>
              {% endfor %}
              <option value="__custom__" {% if form.vcenter_server.value and not vcenters|length %}selected{% endif %}>+ Add new vCenter...</option>
            </select>
            <input type="text" name="vcenter_server_custom" class="form-control mt-2" id="id_vcenter_server_custom" placeholder="vcenter.example.com" style="display: none;" value="">
            <small class="form-text text-muted">Optional: vCenter server managing this VM (leave empty for Proxmox, standalone VMs, or other hypervisors)</small>
{% if form.vcenter_server.errors %}<div class="text-danger">{{ form.vcenter_server.errors }}</div>{% endif %}
          </div>
          <div class="form-group">
            <label for="id_operating_system">Operating System:</label>
            <select name="operating_system" class="form-control" id="id_operating_system">
  <option value="redhat" {% if form.operating_system.value == 'redhat' %}selected{% endif %}>Redhat</option>
  <option value="debian" {% if form.operating_system.value == 'debian' %}selected{% endif %}>Debian</option>
  <option value="windows" {% if form.operating_system.value == 'windows' %}selected{% endif %}>Windows</option>
</select>
          </div>
          <div class="form-group" id="py-interpreter-group">
            <label for="id_ansible_python_interpreter">Python Interpreter:</label>
            <input type="text" name="ansible_python_interpreter" class="form-control" id="id_ansible_python_interpreter" value="{{ form.ansible_python_interpreter.value|default:'/usr/bin/python3' }}">
{% if form.ansible_python_interpreter.errors %}<div class="text-danger">{{ form.ansible_python_interpreter.errors }}</div>{% endif %}
          </div>
          <div class="form-group" id="cred-group">
            <label for="id_deployment_credential">Deployment Credential:</label>
            <select name="deployment_credential" class="form-control" id="id_deployment_credential">
{% if form.deployment_credential.errors %}<div class="text-danger">{{ form.deployment_credential.errors }}</div>{% endif %}
              <option value="" {% if not form.initial.deployment_credential %}selected{% endif %}>-------------</option>
              {% for cred in form.fields.deployment_credential.queryset %}
                <option value="{{ cred.pk }}" {% if form.initial.deployment_credential == cred.pk %}selected{% endif %}>{{ cred.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group" id="windows-cred-group" style="display:none;">
            <label for="id_windows_credential">Windows Credential:</label>
            <select name="windows_credential" class="form-control" id="id_windows_credential">
{% if form.windows_credential.errors %}<div class="text-danger">{{ form.windows_credential.errors }}</div>{% endif %}
              <option value="" {% if not form.initial.windows_credential %}selected{% endif %}>-------------</option>
              {% for cred in form.fields.windows_credential.queryset %}
                <option value="{{ cred.pk }}" {% if form.initial.windows_credential == cred.pk %}selected{% endif %}>{{ cred.name }}</option>
              {% endfor %}
            </select>
          </div>
          {{ form.status }}
          <div class="form-group form-check">
            <input type="checkbox" name="active" class="form-check-input" id="id_active" {% if form.active.value or form.initial.active %}checked{% endif %}>
            <label class="form-check-label" for="id_active">Active</label>
            {% if form.active.errors %}<div class="text-danger">{{ form.active.errors }}</div>{% endif %}
          </div>
          <div class="form-group">
            <label for="id_tags">Tags:</label>
            <input type="text" name="tags" class="form-control" id="id_tags" value="{{ form.tags.value|default:'' }}">
          </div>
          <div class="form-group">
            <label for="id_notes">Notes:</label>
            <textarea name="notes" class="form-control" id="id_notes">{{ form.notes.value|default:'' }}</textarea>
          </div>
          <div class="form-group">
            <label for="id_description">Description:</label>
            <textarea name="description" class="form-control" id="id_description">{{ form.description.value|default:'' }}</textarea>
          </div>
          <button type="submit" class="btn btn-primary">Save</button>
          <a href="{% url 'host_list' %}" class="btn btn-secondary">Cancel</a>
        </form>
      </div>
    </div>
  </div>
  <script>
    // Store all group options on load
    var allGroupOptions = [];
    var groupSelect = document.getElementById('id_group');
    
    // Save initial options
    for (var i = 0; i < groupSelect.options.length; i++) {
      var opt = groupSelect.options[i];
      allGroupOptions.push({
        value: opt.value,
        text: opt.text,
        envId: opt.getAttribute('data-environment-id'),
        selected: opt.selected
      });
    }

    function filterGroups() {
      var environmentId = document.getElementById('id_environment').value;
      var groupSelect = document.getElementById('id_group');
      
      // Keep current selection if possible
      var currentVal = groupSelect.value;
      
      // Clear select
      groupSelect.innerHTML = '';
      
      // Rebuild select with valid options
      allGroupOptions.forEach(function(opt) {
        // Show empty option always, or if environment matches
        // If environmentId is empty (none selected), show all groups? Usually better to show none or all.
        // Let's show all if no env selected, consistent with previous behavior.
        if (opt.value === "" || !environmentId || opt.envId === environmentId) {
          var newOpt = document.createElement('option');
          newOpt.value = opt.value;
          newOpt.text = opt.text;
          if (opt.envId) {
            newOpt.setAttribute('data-environment-id', opt.envId);
          }
          
          // Restore selection if still valid, or if it was selected initially (on page load)
          if (opt.value === currentVal) {
            newOpt.selected = true;
          }
          
          groupSelect.appendChild(newOpt);
        }
      });
      
      // If selection lost, select first
      if (groupSelect.selectedIndex === -1 && groupSelect.options.length > 0) {
        groupSelect.selectedIndex = 0;
      }
    }
    
    document.getElementById('id_environment').addEventListener('change', filterGroups);
    
    // Initialize filter on load
    // We call it after storing options to ensure correct state based on initial environment
    filterGroups();
    
    // Handle vCenter Server selection
    document.getElementById('id_vcenter_server').addEventListener('change', function() {
      var select = this;
      var customInput = document.getElementById('id_vcenter_server_custom');
      
      if (select.value === '__custom__') {
        customInput.style.display = 'block';
        customInput.focus();
        // Clear the select value so the custom input value is used
        select.name = 'vcenter_server_temp';
        customInput.name = 'vcenter_server';
      } else {
        customInput.style.display = 'none';
        select.name = 'vcenter_server';
        customInput.name = 'vcenter_server_custom';
      }
    });
    
    // Initialize on load
    if (document.getElementById('id_vcenter_server').value === '__custom__') {
      document.getElementById('id_vcenter_server_custom').style.display = 'block';
    }
    
    // Toggle fields based on operating system
    function toggleOSFields() {
      var os = document.getElementById('id_operating_system').value;
      var pyInterpreterGroup = document.getElementById('py-interpreter-group');
      var credGroup = document.getElementById('cred-group');
      var windowsCredGroup = document.getElementById('windows-cred-group');
      
      if (os === 'windows') {
        // Hide Linux fields
        pyInterpreterGroup.style.display = 'none';
        credGroup.style.display = 'none';
        // Show Windows fields
        windowsCredGroup.style.display = 'block';
      } else {
        // Show Linux fields
        pyInterpreterGroup.style.display = 'block';
        credGroup.style.display = 'block';
        // Hide Windows fields
        windowsCredGroup.style.display = 'none';
      }
    }
    
    // Add event listener for OS change
    document.getElementById('id_operating_system').addEventListener('change', toggleOSFields);
    
    // Trigger on page load
    toggleOSFields();
  </script>
{% endblock %}
