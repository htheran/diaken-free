{% extends 'base/base.html' %}
{% block title %}Deployment History{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h3 class="card-title mb-0"><i class="bi bi-clock-history"></i> Deployment History</h3>
      <a href="{% url 'history:cleanup_stuck_deployments' %}" class="btn btn-warning btn-sm">
        <i class="bi fa-broom"></i> Cleanup Stuck Deployments
      </a>
    </div>
    
    <!-- Filters -->
    <div class="card-body">
      <form method="get" class="mb-0">
        <div class="row align-items-end">
          <div class="col-12 mb-2">
            <label class="font-weight-bold"><i class="bi bi-funnel"></i> Filters:</label>
          </div>
          
          <div class="col-md-2 mb-2">
            <label class="small text-muted mb-1">Status</label>
            <select name="status" class="form-control form-control-sm">
              <option value="">All Status</option>
              <option value="success" {% if status_filter == 'success' %}selected{% endif %}>Success</option>
              <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>Failed</option>
            </select>
          </div>
          
          <div class="col-md-2 mb-2">
            <label class="small text-muted mb-1">Type</label>
            <select name="type" class="form-control form-control-sm">
              <option value="">All Types</option>
              <option value="host" {% if type_filter == 'host' %}selected{% endif %}>Host</option>
              <option value="group" {% if type_filter == 'group' %}selected{% endif %}>Group</option>
            </select>
          </div>
          
          <div class="col-md-3 mb-2">
            <label class="small text-muted mb-1">From:</label>
            <input type="date" name="date_from" class="form-control form-control-sm" value="{{ date_from }}">
          </div>
          
          <div class="col-md-3 mb-2">
            <label class="small text-muted mb-1">To:</label>
            <input type="date" name="date_to" class="form-control form-control-sm" value="{{ date_to }}">
          </div>
          
          <div class="col-md-2 mb-2">
            <button type="submit" class="btn btn-primary btn-sm btn-block"><i class="bi bi-search"></i> Filter</button>
            <a href="{% url 'history:history_list' %}" class="btn btn-secondary btn-sm btn-block mt-1"><i class="bi fa-eraser"></i> Clear</a>
          </div>
        </div>
      </form>
    </div>
    
    <!-- Table -->
    <div class="card-body p-0">
      <table class="table table-hover table-sm mb-0">
        <thead class="thead-light">
          <tr>
            <th style="width: 8%">ID</th>
            <th style="width: 12%">Date</th>
            <th style="width: 10%">User</th>
            <th style="width: 20%">Target</th>
            <th style="width: 20%">Playbook</th>
            <th style="width: 10%" class="text-center">Status</th>
            <th style="width: 10%" class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for deployment in deployments %}
          <tr>
            <td>{{ deployment.id }}</td>
            <td><i class="bi bi-calendar"></i> {{ deployment.created_at|date:"d/m/Y H:i:s" }}</td>
            <td><i class="bi bi-person"></i> {{ deployment.user.username|default:"Unknown" }}</td>
            <td>
              {% if deployment.target_type == 'host' %}
                <i class="bi fa-desktop"></i>
              {% else %}
                <i class="bi bi-people"></i>
              {% endif %}
              <strong>{{ deployment.target }}</strong>
              <span class="badge badge-secondary">{{ deployment.target_type|title }}</span>
            </td>
            <td><i class="bi bi-file-earmark-code"></i> {{ deployment.playbook }}</td>
            <td class="text-center">
              {% if deployment.status == 'success' %}
                <span class="badge badge-success"><i class="bi bi-check-lg-circle"></i> Success</span>
              {% elif deployment.status == 'failed' %}
                <span class="badge badge-danger"><i class="bi bi-x-lg-circle"></i> Failed</span>
              {% else %}
                {% if deployment.is_stuck %}
                  <span class="badge badge-danger" title="Running for {{ deployment.running_hours|floatformat:1 }} hours">
                    <i class="bi bi-exclamation-triangle"></i> Stuck ({{ deployment.running_hours|floatformat:1 }}h)
                  </span>
                {% else %}
                  <span class="badge badge-warning"><i class="bi fa-spinner fa-spin"></i> Running</span>
                {% endif %}
              {% endif %}
            </td>
            <td class="text-center">
              <a href="{% url 'history:history_detail' deployment.id %}" class="btn btn-sm btn-primary" title="View Details">
                <i class="bi bi-eye"></i> View
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted">No deployment history found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh for running deployments (AJAX - no page reload)
$(document).ready(function() {
  // Find all running deployments and store their IDs
  var runningDeployments = [];
  $('.badge-warning:contains("Running")').each(function() {
    var row = $(this).closest('tr');
    var deploymentId = row.find('td:first').text().trim();
    if (deploymentId) {
      runningDeployments.push({
        id: deploymentId,
        row: row
      });
    }
  });
  
  if (runningDeployments.length > 0) {
    console.log('Found ' + runningDeployments.length + ' running deployment(s), enabling auto-refresh...');
    
    // Check status every 5 seconds
    var refreshInterval = setInterval(function() {
      // Check each running deployment
      runningDeployments.forEach(function(deployment) {
        $.ajax({
          url: '/deploy/history-status/' + deployment.id + '/',
          type: 'GET',
          success: function(data) {
            // Update badge if status changed
            if (data.status === 'success') {
              var statusCell = deployment.row.find('td:nth-child(6)');
              statusCell.html('<span class="badge badge-success"><i class="bi bi-check-lg-circle"></i> Success</span>');
              console.log('Deployment ' + deployment.id + ' completed successfully');
              
              // Remove from running list
              runningDeployments = runningDeployments.filter(function(d) {
                return d.id !== deployment.id;
              });
              
            } else if (data.status === 'failed') {
              var statusCell = deployment.row.find('td:nth-child(6)');
              statusCell.html('<span class="badge badge-danger"><i class="bi bi-x-lg-circle"></i> Failed</span>');
              console.log('Deployment ' + deployment.id + ' failed');
              
              // Remove from running list
              runningDeployments = runningDeployments.filter(function(d) {
                return d.id !== deployment.id;
              });
            }
          },
          error: function(xhr, status, error) {
            console.error('Error checking status for deployment ' + deployment.id + ':', error);
          }
        });
      });
      
      // Stop polling if no more running deployments
      if (runningDeployments.length === 0) {
        clearInterval(refreshInterval);
        console.log('All deployments completed, stopping auto-refresh');
      }
    }, 5000); // Check every 5 seconds
    
    // Stop after 1 hour to prevent infinite polling
    setTimeout(function() {
      clearInterval(refreshInterval);
      console.log('Auto-refresh stopped after 1 hour');
    }, 3600000);
  }
});
</script>
{% endblock %}
