{% extends 'base/base.html' %}
{% block title %}Cleanup Stuck Deployments{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-warning text-white">
          <h3 class="card-title mb-0">
            <i class="fas fa-broom"></i> Cleanup Stuck Deployments
          </h3>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> <strong>What does this do?</strong><br>
            This tool finds deployments and scheduled tasks that have been running for longer than the specified timeout 
            and marks them as "failed". This is useful when deployments get stuck due to server restarts or network issues.
          </div>

          <!-- Cleanup Form -->
          <form method="post" class="mb-4">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label for="{{ form.timeout_hours.id_for_label }}">
                    <i class="fas fa-clock"></i> {{ form.timeout_hours.label }}
                  </label>
                  {{ form.timeout_hours }}
                  <small class="form-text text-muted">{{ form.timeout_hours.help_text }}</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label>&nbsp;</label>
                  <div class="form-check">
                    {{ form.dry_run }}
                    <label class="form-check-label" for="{{ form.dry_run.id_for_label }}">
                      {{ form.dry_run.label }}
                    </label>
                  </div>
                  <small class="form-text text-muted">{{ form.dry_run.help_text }}</small>
                </div>
              </div>
              <div class="col-md-5">
                <div class="form-group">
                  <label>&nbsp;</label><br>
                  <button type="submit" class="btn btn-warning">
                    <i class="fas fa-search"></i> Check for Stuck Deployments
                  </button>
                  <a href="{% url 'history:history_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to History
                  </a>
                </div>
              </div>
            </div>
          </form>

          <!-- Results -->
          {% if results %}
          <hr>
          <div class="card {% if results.dry_run %}border-warning{% else %}border-success{% endif %}">
            <div class="card-header {% if results.dry_run %}bg-warning{% else %}bg-success{% endif %} text-white">
              <h5 class="mb-0">
                {% if results.dry_run %}
                  <i class="fas fa-eye"></i> Preview Results (Dry Run)
                {% else %}
                  <i class="fas fa-check-circle"></i> Cleanup Results
                {% endif %}
              </h5>
            </div>
            <div class="card-body">
              <p class="mb-3">
                <strong>Timeout:</strong> {{ results.timeout_hours }} hours<br>
                <strong>Total items found:</strong> {{ results.total }}
              </p>

              {% if results.deployments %}
              <h6><i class="fas fa-server"></i> Stuck Deployments ({{ results.deployments|length }})</h6>
              <div class="table-responsive mb-3">
                <table class="table table-sm table-hover">
                  <thead class="thead-light">
                    <tr>
                      <th>ID</th>
                      <th>Target</th>
                      <th>Playbook</th>
                      <th>Started</th>
                      <th>Running Time</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for dep in results.deployments %}
                    <tr>
                      <td><a href="{% url 'history:history_detail' dep.id %}">#{{ dep.id }}</a></td>
                      <td>{{ dep.target }}</td>
                      <td>{{ dep.playbook }}</td>
                      <td>{{ dep.started|date:"d/m/Y H:i:s" }}</td>
                      <td><span class="badge badge-danger">{{ dep.hours|floatformat:1 }} hours</span></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% endif %}

              {% if results.tasks %}
              <h6><i class="fas fa-calendar-check"></i> Stuck Scheduled Tasks ({{ results.tasks|length }})</h6>
              <div class="table-responsive">
                <table class="table table-sm table-hover">
                  <thead class="thead-light">
                    <tr>
                      <th>ID</th>
                      <th>Target</th>
                      <th>Playbook</th>
                      <th>Started</th>
                      <th>Running Time</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for task in results.tasks %}
                    <tr>
                      <td>#{{ task.id }}</td>
                      <td>{{ task.target }}</td>
                      <td>{{ task.playbook }}</td>
                      <td>{{ task.started|date:"d/m/Y H:i:s" }}</td>
                      <td><span class="badge badge-danger">{{ task.hours|floatformat:1 }} hours</span></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% endif %}

              {% if results.total == 0 %}
              <div class="alert alert-success mb-0">
                <i class="fas fa-check-circle"></i> No stuck deployments or tasks found!
              </div>
              {% endif %}

              {% if results.dry_run and results.total > 0 %}
              <div class="alert alert-warning mt-3 mb-0">
                <i class="fas fa-exclamation-triangle"></i> <strong>This was a dry run.</strong> 
                Uncheck "Dry Run" and submit again to actually mark these items as failed.
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Currently Running Deployments -->
          <hr>
          <div class="card">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">
                <i class="fas fa-tasks"></i> Currently Running Deployments
              </h5>
            </div>
            <div class="card-body">
              {% if running_deployments %}
              <div class="table-responsive">
                <table class="table table-sm table-hover">
                  <thead class="thead-light">
                    <tr>
                      <th>ID</th>
                      <th>Target</th>
                      <th>Playbook</th>
                      <th>Started</th>
                      <th>Running Time</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for dep in running_deployments %}
                    <tr>
                      <td><a href="{% url 'history:history_detail' dep.id %}">#{{ dep.id }}</a></td>
                      <td>{{ dep.target }}</td>
                      <td>{{ dep.playbook }}</td>
                      <td>{{ dep.created_at|date:"d/m/Y H:i:s" }}</td>
                      <td>
                        {% if dep.running_hours > 2 %}
                          <span class="badge badge-danger">{{ dep.running_hours|floatformat:1 }} hours</span>
                        {% elif dep.running_hours > 1 %}
                          <span class="badge badge-warning">{{ dep.running_hours|floatformat:1 }} hours</span>
                        {% else %}
                          <span class="badge badge-info">{{ dep.running_hours|floatformat:1 }} hours</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if dep.running_hours > 2 %}
                          <span class="badge badge-danger"><i class="fas fa-exclamation-triangle"></i> Likely Stuck</span>
                        {% else %}
                          <span class="badge badge-success"><i class="fas fa-check"></i> Normal</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <div class="alert alert-success mb-0">
                <i class="fas fa-check-circle"></i> No deployments currently running
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Help Section -->
          <hr>
          <div class="card">
            <div class="card-header bg-secondary text-white">
              <h5 class="mb-0">
                <i class="fas fa-question-circle"></i> Help & Information
              </h5>
            </div>
            <div class="card-body">
              <h6><i class="fas fa-info-circle"></i> When to use this tool:</h6>
              <ul>
                <li>After a server restart when deployments might have been interrupted</li>
                <li>When you see deployments stuck in "Running" status for a long time</li>
                <li>To clean up orphaned deployment records</li>
              </ul>

              <h6><i class="fas fa-exclamation-triangle"></i> Important Notes:</h6>
              <ul>
                <li><strong>Dry Run:</strong> Always use "Dry Run" first to preview what will be affected</li>
                <li><strong>Timeout:</strong> Adjust the timeout based on your playbooks. Some may legitimately take longer</li>
                <li><strong>Scheduled Tasks:</strong> This only affects tasks that are currently "running", not future scheduled tasks</li>
                <li><strong>Automatic Cleanup:</strong> A cron job runs every 30 minutes with a 6-hour timeout</li>
              </ul>

              <h6><i class="fas fa-cog"></i> Cron Job Configuration:</h6>
              <p>The automatic cleanup runs every 30 minutes:</p>
              <pre class="bg-dark text-light p-2"><code>*/30 * * * * /opt/www/app/sc/cleanup_stuck_deployments.sh >> /var/log/cleanup_stuck_deployments.log 2>&1</code></pre>
              <p class="mb-0">
                <small class="text-muted">
                  To view logs: <code>tail -f /var/log/cleanup_stuck_deployments.log</code>
                </small>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
