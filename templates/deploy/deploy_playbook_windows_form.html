{% extends 'base/base.html' %}
{% block title %}Execute Windows Playbook{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title"><i class="bi bi-windows"></i> Execute Windows Playbook</h3>
    </div>
    <div class="card-body">
      <form id="playbookForm" method="post">
        {% csrf_token %}
        
        <!-- Target Type Selection -->
        <div class="form-group">
          <label for="target_type">Target Type: <span class="text-danger">*</span></label>
          <select name="target_type" id="target_type" class="form-control" required>
            <option value="">Select target type...</option>
            <option value="host">Host</option>
            <option value="group">Group</option>
          </select>
        </div>
        
        <!-- Environment Filter -->
        <div class="form-group">
          <label for="environment">Environment:</label>
          <select name="environment" id="environment" class="form-control">
            <option value="">All environments</option>
            {% for env in environments %}
              <option value="{{ env.id }}">{{ env.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Group Filter (shown when filtering hosts) -->
        <div class="form-group" id="group-filter-div">
          <label for="group_filter">Group Filter:</label>
          <select name="group_filter" id="group_filter" class="form-control">
            <option value="">All groups</option>
            {% for grp in groups %}
              <option value="{{ grp.id }}" data-environment="{{ grp.environment.id }}">{{ grp.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Host Selection (shown when target_type is 'host') -->
        <div class="form-group" id="host-selection-div" style="display:none;">
          <label for="host">Host: <span class="text-danger">*</span></label>
          <select name="host" id="host" class="form-control">
            <option value="">Select a Windows host...</option>
            {% for h in hosts %}
              <option value="{{ h.id }}" data-environment="{{ h.environment.id }}" data-group="{{ h.group.id|default:'' }}">
                {{ h.name }} ({{ h.ip }}) - {{ h.environment.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Group Selection (shown when target_type is 'group') -->
        <div class="form-group" id="group-selection-div" style="display:none;">
          <label for="group">Group: <span class="text-danger">*</span></label>
          <select name="group" id="group" class="form-control">
            <option value="">Select a group...</option>
            {% for grp in groups %}
              <option value="{{ grp.id }}" data-environment="{{ grp.environment.id }}">{{ grp.name }} - {{ grp.environment.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Execution Type Selection -->
        <div class="form-group">
          <label for="execution_type">Execution Type: <span class="text-danger">*</span></label>
          <select name="execution_type" id="execution_type" class="form-control" required>
            <option value="playbook">Playbook</option>
            <option value="script">PowerShell Script</option>
          </select>
        </div>
        
        <!-- Playbook Selection -->
        <div class="form-group" id="playbook-selection-div">
          <label for="playbook">Playbook: <span class="text-danger">*</span></label>
          <select name="playbook" id="playbook" class="form-control" required>
            <option value="">Select a playbook...</option>
          </select>
          <small class="text-muted">Only Windows playbooks are shown</small>
        </div>
        
        <!-- Script Selection -->
        <div class="form-group" id="script-selection-div" style="display:none;">
          <label for="script">PowerShell Script: <span class="text-danger">*</span></label>
          <select name="script" id="script" class="form-control">
            <option value="">Select a script...</option>
          </select>
          <small class="text-muted">PowerShell scripts filtered by target type</small>
        </div>
        
        <!-- Snapshot Option (only for hosts) -->
        <div class="form-group" id="snapshot-div" style="display:none;">
          <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id="create_snapshot" name="create_snapshot" value="1">
            <label class="custom-control-label" for="create_snapshot">
              <i class="bi bi-camera"></i> Create snapshot before execution
              <small class="text-muted d-block">Safety snapshot will be auto-deleted after configured retention period</small>
            </label>
          </div>
        </div>
        
        <!-- Scheduled Task Option -->
        <div class="form-group">
          <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id="scheduled" name="scheduled" value="1">
            <label class="custom-control-label" for="scheduled">
              <i class="bi bi-clock"></i> Schedule for later execution
            </label>
          </div>
        </div>
        
        <!-- Scheduled Time (shown when scheduled is checked) -->
        <div class="form-group" id="scheduled-time-div" style="display:none;">
          <label for="scheduled_time">Scheduled Time:</label>
          <input type="datetime-local" name="scheduled_time" id="scheduled_time" class="form-control">
          <small class="text-muted">Leave empty to execute immediately</small>
        </div>
        
        <div class="form-group">
          <button type="submit" class="btn btn-success" id="submitBtn">
            <i class="bi bi-play"></i> <span id="submitBtnText">Execute Playbook</span>
          </button>
          <a href="{% url 'deploy:deploy_index' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back
          </a>
        </div>
      </form>
      
      <!-- Progress Bar -->
      <div id="progressArea" style="display:none;" class="mt-4">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-spinner fa-spin"></i> Executing Playbook...</h5>
          </div>
          <div class="card-body">
            <div class="progress" style="height: 30px;">
              <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                   role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <span id="progressText">0%</span>
              </div>
            </div>
            <p class="mt-3 mb-0" id="progressStatus">Initializing...</p>
            
            <!-- Real-time Output Collapsible -->
            <div class="mt-3" id="realtimeOutputContainer" style="display:none;">
              <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse" data-target="#realtimeOutput" aria-expanded="false" aria-controls="realtimeOutput">
                <i class="bi bi-terminal"></i> Show Real-time Output
              </button>
              <div class="collapse mt-2" id="realtimeOutput">
                <div class="card card-body bg-dark text-light" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                  <pre id="realtimeOutputContent" class="mb-0" style="color: #00ff00;"></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Result Area -->
      <div id="resultArea" style="display:none;" class="mt-4">
        <div class="card">
          <div class="card-header" id="resultHeader">
            <h5 id="resultTitle"></h5>
          </div>
          <div class="card-body">
            <pre id="resultOutput" style="max-height: 400px; overflow-y: auto; color: white; background-color: #1e1e1e;"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function() {
  // Toggle target-specific fields
  $('#target_type').change(function() {
    var targetType = $(this).val();
    
    if (targetType === 'host') {
      $('#host-selection-div').show();
      $('#group-selection-div').hide();
      $('#group-filter-div').show();
      $('#snapshot-div').show();
      $('#group').removeAttr('required');
      $('#host').attr('required', 'required');
    } else if (targetType === 'group') {
      $('#host-selection-div').hide();
      $('#group-selection-div').show();
      $('#group-filter-div').hide();
      $('#snapshot-div').show();
      $('#host').removeAttr('required');
      $('#group').attr('required', 'required');
    } else {
      $('#host-selection-div').hide();
      $('#group-selection-div').hide();
      $('#group-filter-div').hide();
      $('#snapshot-div').hide();
      $('#host').removeAttr('required');
      $('#group').removeAttr('required');
    }
    
    // Update playbooks or scripts based on execution type
    var executionType = $('#execution_type').val();
    if (executionType === 'playbook') {
      updatePlaybooks();
    } else if (executionType === 'script') {
      updateScripts();
    }
  });
  
  // Toggle scheduled time field
  $('#scheduled').change(function() {
    if ($(this).is(':checked')) {
      $('#scheduled-time-div').show();
    } else {
      $('#scheduled-time-div').hide();
    }
  });
  
  // Filter groups by environment
  function filterGroups() {
    var envId = $('#environment').val();
    var $groupFilter = $('#group_filter');
    var $groupSelect = $('#group');
    
    // Keep current selection if possible
    var currentGroupFilter = $groupFilter.val();
    var currentGroupSelect = $groupSelect.val();
    
    $.ajax({
      url: '{% url "deploy:ajax_get_groups" %}',
      data: { 'environment_id': envId },
      success: function(data) {
        // Update group filter
        $groupFilter.empty();
        $groupFilter.append('<option value="">All groups</option>');
        data.groups.forEach(function(group) {
          var selected = (group.id == currentGroupFilter) ? 'selected' : '';
          $groupFilter.append('<option value="' + group.id + '" ' + selected + '>' + group.name + '</option>');
        });
        
        // Update group selector
        $groupSelect.empty();
        $groupSelect.append('<option value="">Select a group...</option>');
        data.groups.forEach(function(group) {
          var selected = (group.id == currentGroupSelect) ? 'selected' : '';
          $groupSelect.append('<option value="' + group.id + '" ' + selected + '>' + group.name + ' - ' + group.environment_name + '</option>');
        });
        
        // Refresh hosts
        filterHosts();
      },
      error: function() {
        console.error('Error loading groups');
      }
    });
  }
  
  // Filter hosts by environment and group
  function filterHosts() {
    var envId = $('#environment').val();
    var groupId = $('#group_filter').val();
    var $hostSelect = $('#host');
    
    // Keep current selection if possible
    var currentHost = $hostSelect.val();
    
    $.ajax({
      url: '{% url "deploy:ajax_get_hosts" %}',
      data: { 
        'environment_id': envId,
        'group_id': groupId,
        'os_family': 'windows'
      },
      success: function(data) {
        $hostSelect.empty();
        $hostSelect.append('<option value="">Select a Windows host...</option>');
        data.hosts.forEach(function(host) {
          var selected = (host.id == currentHost) ? 'selected' : '';
          $hostSelect.append('<option value="' + host.id + '" ' + selected + '>' + host.name + ' (' + host.ip + ') - ' + host.environment_name + '</option>');
        });
      },
      error: function() {
        console.error('Error loading hosts');
      }
    });
  }
  
  // Toggle execution type fields
  $('#execution_type').change(function() {
    var executionType = $(this).val();
    
    if (executionType === 'playbook') {
      $('#playbook-selection-div').show();
      $('#script-selection-div').hide();
      $('#playbook').attr('required', 'required');
      $('#script').removeAttr('required');
      $('#submitBtnText').text('Execute Playbook');
      updatePlaybooks();
    } else if (executionType === 'script') {
      $('#playbook-selection-div').hide();
      $('#script-selection-div').show();
      $('#script').attr('required', 'required');
      $('#playbook').removeAttr('required');
      $('#submitBtnText').text('Execute PowerShell Script');
      updateScripts();
    }
  });
  
  // Update playbooks based on target type
  function updatePlaybooks() {
    var targetType = $('#target_type').val();
    var $playbook = $('#playbook');
    
    $playbook.empty();
    $playbook.append('<option value="">Select a playbook...</option>');
    
    if (targetType === 'host') {
      {% for pb in playbooks_host %}
        $playbook.append('<option value="{{ pb.id }}">{{ pb.name }} - {{ pb.description|truncatewords:10 }}</option>');
      {% endfor %}
    } else if (targetType === 'group') {
      {% for pb in playbooks_group %}
        $playbook.append('<option value="{{ pb.id }}">{{ pb.name }} - {{ pb.description|truncatewords:10 }}</option>');
      {% endfor %}
    }
  }
  
  // Update scripts based on target type
  function updateScripts() {
    var targetType = $('#target_type').val();
    var $script = $('#script');
    
    $script.empty();
    $script.append('<option value="">Select a script...</option>');
    
    if (!targetType) {
      return;
    }
    
    // Load scripts via AJAX
    $.ajax({
      url: '/scripts/get-scripts/',
      data: {
        target_type: targetType,
        os_family: 'windows'
      },
      success: function(data) {
        if (data.scripts && data.scripts.length > 0) {
          data.scripts.forEach(function(script) {
            $script.append('<option value="' + script.id + '">' + script.name + ' - ' + script.description + '</option>');
          });
        } else {
          $script.append('<option value="" disabled>No PowerShell scripts available</option>');
        }
      },
      error: function() {
        alert('Error loading scripts');
      }
    });
  }
  
  $('#environment').change(function() {
    filterGroups();
    filterHosts();
  });
  
  $('#group_filter').change(function() {
    filterHosts();
  });
  
  // Form submission
  $('#playbookForm').submit(function(e) {
    e.preventDefault();
    
    var $submitBtn = $('#submitBtn');
    var originalText = $submitBtn.html();
    $submitBtn.prop('disabled', true).html('<i class="bi bi-spinner fa-spin"></i> Executing...');
    
    // Show progress bar
    $('#progressArea').show();
    $('#resultArea').hide();
    
    // Simulate progress (since we can't get real-time updates from synchronous execution)
    var progress = 0;
    var progressInterval = setInterval(function() {
      progress += 5;
      if (progress <= 90) {
        $('#progressBar').css('width', progress + '%').attr('aria-valuenow', progress);
        $('#progressText').text(progress + '%');
        
        if (progress < 30) {
          $('#progressStatus').text('Connecting to host...');
        } else if (progress < 60) {
          $('#progressStatus').text('Executing playbook tasks...');
        } else {
          $('#progressStatus').text('Finalizing execution...');
        }
      }
    }, 200);
    
    $.ajax({
      url: '{% url "deploy:execute_playbook_windows" %}',
      method: 'POST',
      data: $(this).serialize(),
      success: function(response) {
        // Check if this is an async execution with Celery
        if (response.async && response.task_id) {
          // Async execution - stop simulation progress and start polling
          clearInterval(progressInterval);
          $('#progressStatus').text('Execution started in background...');
          // Show and expand real-time output
          $('#realtimeOutputContainer').show();
          $('#realtimeOutput').collapse('show');
          $('#realtimeOutputContent').text('Waiting for output...\n');
          startTaskPolling(response.task_id, response.history_id);
          return;
        }
        
        clearInterval(progressInterval);
        $('#progressBar').css('width', '100%').attr('aria-valuenow', 100);
        $('#progressText').text('100%');
        $('#progressStatus').text('Completed!');
        
        setTimeout(function() {
          $('#progressArea').hide();
          $submitBtn.prop('disabled', false).html(originalText);
        
        if (response.success) {
          $('#resultArea').show();
          $('#resultHeader').removeClass('bg-danger').addClass('bg-success');
          $('#resultTitle').html('<i class="bi bi-check-lg-circle"></i> Success');
          $('#resultOutput').text(response.output || response.message);
          
          // Show success message
          alert('Playbook executed successfully!');
          
          // Optionally redirect to history
          if (response.history_id) {
            window.location.href = '/history/' + response.history_id + '/';
          }
        } else {
          $('#resultArea').show();
          $('#resultHeader').removeClass('bg-success').addClass('bg-danger');
          $('#resultTitle').html('<i class="bi bi-x-lg-circle"></i> Error');
          $('#resultOutput').text(response.details || response.error);
          
          alert('Error: ' + response.error);
        }
        }, 1000);
      },
      error: function() {
        clearInterval(progressInterval);
        $('#progressArea').hide();
        $submitBtn.prop('disabled', false).html(originalText);
        alert('An error occurred while executing the playbook.');
      }
    });
  });
  
  // Initialize
  filterGroups();
  filterHosts();
});
  // Function to poll task status for Windows
  function startTaskPolling(taskId, historyId) {
    var pollInterval = 3000; // Poll every 3 seconds
    var pollCount = 0;
    var maxPolls = 1800; // Max 90 minutes (1800 * 3 seconds)
    
    function checkStatus() {
      pollCount++;
      
      // Calculate realistic progress based on time (max 90 minutes = 1800 polls)
      // Progress grows slower as it approaches 100%
      var estimatedProgress = Math.min(95, Math.floor(10 + (pollCount / maxPolls) * 85));
      $('#progressBar').css('width', estimatedProgress + '%').attr('aria-valuenow', estimatedProgress);
      $('#progressText').text(estimatedProgress + '%');
      
      $.ajax({
        url: '/deploy/history-status/' + historyId + '/',
        type: 'GET',
        success: function(data) {
          // Update progress text with elapsed time
          var elapsedMinutes = Math.floor((pollCount * 3) / 60);
          var elapsedSeconds = (pollCount * 3) % 60;
          var timeStr = elapsedMinutes + 'm ' + elapsedSeconds + 's';
          $('#progressStatus').text('Status: ' + data.status + ' - Elapsed: ' + timeStr);
          
          // Show real-time output if available
          if (data.output && data.output.trim()) {
            $('#realtimeOutputContainer').show();
            $('#realtimeOutputContent').text(data.output);
            // Auto-expand output on first content
            var outputContainer = $('#realtimeOutput');
            if (!outputContainer.hasClass('show') && pollCount === 1) {
              outputContainer.collapse('show');
            }
            // Auto-scroll to bottom
            if (outputContainer.hasClass('show')) {
              var pre = $('#realtimeOutputContent')[0];
              if (pre) {
                pre.scrollTop = pre.scrollHeight;
              }
            }
          }
          
          // Check if task is complete
          if (data.status === 'success' || data.status === 'failed') {
            // Task completed
            $('#progressBar').css('width', '100%').attr('aria-valuenow', 100);
            $('#progressText').text('100%');
            $('#progressStatus').text('Completed!');
            
            setTimeout(function() {
              $('#progressArea').hide();
              $('#resultArea').show();
              
              if (data.status === 'success') {
                $('#resultHeader').removeClass('bg-danger').addClass('bg-success text-white');
                $('#resultTitle').html('<i class="bi bi-check-lg-circle"></i> Windows Playbook Executed Successfully');
              } else {
                $('#resultHeader').removeClass('bg-success').addClass('bg-danger text-white');
                $('#resultTitle').html('<i class="bi bi-x-lg-circle"></i> Execution Failed');
              }
              
              // Show output
              var output = data.output || 'No output available';
              $('#resultOutput').text(output);
            }, 500);
          } else if (pollCount >= maxPolls) {
            // Timeout after max polls
            clearInterval(progressInterval);
            $('#progressStatus').text('Polling timeout - task may still be running');
            $('#resultArea').show();
            $('#resultHeader').removeClass('bg-success').addClass('bg-warning text-white');
            $('#resultTitle').html('<i class="bi bi-exclamation-triangle"></i> Polling Timeout');
            $('#resultOutput').text('The task is taking longer than expected. It may still be running in the background.\n\nPlease check the History page for the final result.');
          } else {
            // Continue polling
            setTimeout(checkStatus, pollInterval);
          }
        },
        error: function() {
          // On error, continue polling (maybe temporary network issue)
          if (pollCount < maxPolls) {
            setTimeout(checkStatus, pollInterval);
          }
        }
      });
    }
    
    // Start polling
    checkStatus();
  }
</script>
{% endblock %}
