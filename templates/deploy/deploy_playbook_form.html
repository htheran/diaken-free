{% extends 'base/base.html' %}
{% block title %}Execute Linux Playbook{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title"><i class="fab fa-linux"></i> Execute Linux Script/Playbook</h3>
    </div>
    <div class="card-body">
      <form id="playbookForm" method="post">
        {% csrf_token %}
        
        <!-- Execution Type Selection -->
        <div class="form-group">
          <label for="execution_type">Execution Type: <span class="text-danger">*</span></label>
          <select name="execution_type" id="execution_type" class="form-control" required>
            <option value="">Select execution type...</option>
            <option value="playbook">Playbook</option>
            <option value="script">Script</option>
          </select>
        </div>
        
        <!-- OS Family Selection -->
        <div class="form-group">
          <label for="os_family">OS Family: <span class="text-danger">*</span></label>
          <select name="os_family" id="os_family" class="form-control" required>
            <option value="">Select OS family...</option>
            <option value="redhat">RedHat/CentOS/Oracle Linux</option>
            <option value="debian">Debian/Ubuntu</option>
          </select>
        </div>
        
        <!-- Target Type Selection -->
        <div class="form-group">
          <label for="target_type">Target Type: <span class="text-danger">*</span></label>
          <select name="target_type" id="target_type" class="form-control" required>
            <option value="">Select target type...</option>
            <option value="host">Host</option>
            <option value="group">Group</option>
          </select>
        </div>
        
        <!-- Environment Filter -->
        <div class="form-group">
          <label for="environment">Environment:</label>
          <select name="environment" id="environment" class="form-control">
            <option value="">All environments</option>
            {% for env in environments %}
              <option value="{{ env.id }}">{{ env.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Group Filter (shown when filtering hosts) -->
        <div class="form-group" id="group-filter-div">
          <label for="group_filter">Group Filter:</label>
          <select name="group_filter" id="group_filter" class="form-control">
            <option value="">All groups</option>
            {% for grp in groups %}
              <option value="{{ grp.id }}" data-environment="{{ grp.environment.id }}">{{ grp.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Host Selection (shown when target_type is 'host') -->
        <div class="form-group" id="host-selection-div" style="display:none;">
          <label for="host">Host: <span class="text-danger">*</span></label>
          <select name="host" id="host" class="form-control">
            <option value="">Select a Linux host...</option>
            {% for h in hosts %}
              <option value="{{ h.id }}" data-environment="{{ h.environment.id }}" data-group="{{ h.group.id|default:'' }}" data-os="{{ h.operating_system }}">
                {{ h.name }} ({{ h.ip }}) - {{ h.environment.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Group Selection (shown when target_type is 'group') -->
        <div class="form-group" id="group-selection-div" style="display:none;">
          <label for="group">Group: <span class="text-danger">*</span></label>
          <select name="group" id="group" class="form-control">
            <option value="">Select a group...</option>
            {% for grp in groups %}
              <option value="{{ grp.id }}" data-environment="{{ grp.environment.id }}">{{ grp.name }} - {{ grp.environment.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <!-- Playbook Selection (shown when execution_type is 'playbook') -->
        <div class="form-group" id="playbook-selection-div" style="display:none;">
          <label for="playbook">Playbook: <span class="text-danger">*</span></label>
          <select name="playbook" id="playbook" class="form-control">
            <option value="">Select a playbook...</option>
          </select>
          <small class="text-muted">Playbooks filtered by OS family and target type</small>
        </div>
        
        <!-- Script Selection (shown when execution_type is 'script') -->
        <div class="form-group" id="script-selection-div" style="display:none;">
          <label for="script">Script: <span class="text-danger">*</span></label>
          <select name="script" id="script" class="form-control">
            <option value="">Select a script...</option>
          </select>
          <small class="text-muted">Scripts filtered by OS family and target type</small>
        </div>
        
        <!-- Snapshot Option -->
        <div class="form-group" id="snapshot-div" style="display:none;">
          <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id="create_snapshot" name="create_snapshot" value="1">
            <label class="custom-control-label" for="create_snapshot">
              <i class="fas fa-camera"></i> <span id="snapshot-label">Create snapshot before execution</span>
              <small class="text-muted d-block" id="snapshot-help">Safety snapshot will be auto-deleted after configured retention period</small>
            </label>
          </div>
        </div>
        
        <!-- Scheduled Task Option -->
        <div class="form-group">
          <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id="scheduled" name="scheduled" value="1">
            <label class="custom-control-label" for="scheduled">
              <i class="fas fa-clock"></i> Schedule for later execution
            </label>
          </div>
        </div>
        
        <!-- Scheduled Time (shown when scheduled is checked) -->
        <div class="form-group" id="scheduled-time-div" style="display:none;">
          <label for="scheduled_time">Scheduled Time:</label>
          <input type="datetime-local" class="form-control" id="scheduled_time" name="scheduled_time">
          <small class="text-muted">Leave empty for immediate execution</small>
        </div>
        
        <button type="submit" class="btn btn-primary"><i class="fas fa-play"></i> Execute Playbook</button>
        <a href="{% url 'deploy:deploy_index' %}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back</a>
      </form>
      
      <!-- Progress Bar -->
      <div id="progressArea" style="display:none;" class="mt-4">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0" id="progressTitle"><i class="fas fa-spinner fa-spin"></i> Executing...</h5>
          </div>
          <div class="card-body">
            <div class="progress" style="height: 30px;">
              <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                   role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <span id="progressText">0%</span>
              </div>
            </div>
            <p class="mt-3 mb-0" id="progressStatus">Initializing...</p>
            
            <!-- Real-time Output Collapsible -->
            <div class="mt-3" id="realtimeOutputContainer" style="display:none;">
              <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse" data-target="#realtimeOutput" aria-expanded="false" aria-controls="realtimeOutput">
                <i class="fas fa-terminal"></i> Show Real-time Output
              </button>
              <div class="collapse mt-2" id="realtimeOutput">
                <div class="card card-body bg-dark text-light" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                  <pre id="realtimeOutputContent" class="mb-0" style="color: #00ff00;"></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Result Area -->
      <div id="resultArea" style="display:none;" class="mt-4">
        <div class="card">
          <div class="card-header" id="resultHeader">
            <h5 class="card-title mb-0" id="resultTitle"></h5>
          </div>
          <div class="card-body">
            <div id="resultContent"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function() {
  // Toggle execution type fields
  $('#execution_type').change(function() {
    var executionType = $(this).val();
    
    if (executionType === 'playbook') {
      $('#playbook-selection-div').show();
      $('#script-selection-div').hide();
      $('#playbook').prop('required', true);
      $('#script').prop('required', false);
      updatePlaybooksOrScripts();
    } else if (executionType === 'script') {
      $('#playbook-selection-div').hide();
      $('#script-selection-div').show();
      $('#playbook').prop('required', false);
      $('#script').prop('required', true);
      updatePlaybooksOrScripts();
    } else {
      $('#playbook-selection-div').hide();
      $('#script-selection-div').hide();
      $('#playbook').prop('required', false);
      $('#script').prop('required', false);
    }
  });
  
  // Update playbooks/scripts when OS family changes
  $('#os_family').change(function() {
    updatePlaybooksOrScripts();
  });
  
  // Toggle target-specific fields
  $('#target_type').change(function() {
    var targetType = $(this).val();
    
    if (targetType === 'host') {
      $('#host-selection-div').show();
      $('#group-selection-div').hide();
      $('#snapshot-div').show();
      $('#snapshot-label').text('Create snapshot before execution');
      $('#snapshot-help').text('Safety snapshot will be auto-deleted after configured retention period');
      $('#group-filter-div').show();
      $('#host').prop('required', true);
      $('#group').prop('required', false);
      updatePlaybooksOrScripts();
    } else if (targetType === 'group') {
      $('#host-selection-div').hide();
      $('#group-selection-div').show();
      $('#snapshot-div').show();
      $('#snapshot-label').text('Create snapshot before execution (all hosts)');
      $('#snapshot-help').text('Safety snapshots will be created for all hosts in the group and auto-deleted after configured retention period');
      $('#group-filter-div').hide();
      $('#host').prop('required', false);
      $('#group').prop('required', true);
      $('#create_snapshot').prop('checked', false);
      updatePlaybooksOrScripts();
    } else {
      $('#host-selection-div').hide();
      $('#group-selection-div').hide();
      $('#snapshot-div').hide();
      $('#group-filter-div').hide();
      $('#host').prop('required', false);
      $('#group').prop('required', false);
    }
  });
  
  // Toggle scheduled time field
  $('#scheduled').change(function() {
    if ($(this).is(':checked')) {
      $('#scheduled-time-div').show();
      $('#scheduled_time').prop('required', true);
    } else {
      $('#scheduled-time-div').hide();
      $('#scheduled_time').prop('required', false);
    }
  });
  
  // Filter groups by environment
  function filterGroups() {
    var envId = $('#environment').val();
    var $groupFilter = $('#group_filter');
    var $groupSelect = $('#group');
    
    // Keep current selection if possible
    var currentGroupFilter = $groupFilter.val();
    var currentGroupSelect = $groupSelect.val();
    
    $.ajax({
      url: '{% url "deploy:ajax_get_groups" %}',
      data: { 'environment_id': envId },
      success: function(data) {
        // Update group filter
        $groupFilter.empty();
        $groupFilter.append('<option value="">All groups</option>');
        data.groups.forEach(function(group) {
          var selected = (group.id == currentGroupFilter) ? 'selected' : '';
          $groupFilter.append('<option value="' + group.id + '" ' + selected + '>' + group.name + '</option>');
        });
        
        // Update group selector
        $groupSelect.empty();
        $groupSelect.append('<option value="">Select a group...</option>');
        data.groups.forEach(function(group) {
          var selected = (group.id == currentGroupSelect) ? 'selected' : '';
          $groupSelect.append('<option value="' + group.id + '" ' + selected + '>' + group.name + ' - ' + group.environment_name + '</option>');
        });
        
        // Refresh hosts
        filterHosts();
      },
      error: function() {
        console.error('Error loading groups');
      }
    });
  }
  
  // Filter hosts by environment, group and OS family
  function filterHosts() {
    var envId = $('#environment').val();
    var groupId = $('#group_filter').val();
    var osFamily = $('#os_family').val();
    var $hostSelect = $('#host');
    
    // Keep current selection if possible
    var currentHost = $hostSelect.val();
    
    $.ajax({
      url: '{% url "deploy:ajax_get_hosts" %}',
      data: { 
        'environment_id': envId,
        'group_id': groupId,
        'os_family': osFamily
      },
      success: function(data) {
        $hostSelect.empty();
        $hostSelect.append('<option value="">Select a Linux host...</option>');
        data.hosts.forEach(function(host) {
          var selected = (host.id == currentHost) ? 'selected' : '';
          $hostSelect.append('<option value="' + host.id + '" ' + selected + '>' + host.name + ' (' + host.ip + ') - ' + host.environment_name + '</option>');
        });
      },
      error: function() {
        console.error('Error loading hosts');
      }
    });
  }
  
  // Update playbooks or scripts based on execution type, OS family, and target type
  function updatePlaybooksOrScripts() {
    var executionType = $('#execution_type').val();
    var osFamily = $('#os_family').val();
    var targetType = $('#target_type').val();
    
    if (!executionType || !osFamily || !targetType) return;
    
    if (executionType === 'playbook') {
      // Load playbooks
      $.ajax({
        url: '{% url "deploy:get_playbooks" %}',
        type: 'GET',
        data: { target_type: targetType, os_family: osFamily },
        success: function(response) {
          $('#playbook').html('<option value="">Select a playbook...</option>');
          response.playbooks.forEach(function(pb) {
            $('#playbook').append('<option value="' + pb.id + '">' + pb.name + '</option>');
          });
        }
      });
    } else if (executionType === 'script') {
      // Load scripts
      $.ajax({
        url: '/scripts/get-scripts/',
        type: 'GET',
        data: { target_type: targetType, os_family: osFamily },
        success: function(response) {
          $('#script').html('<option value="">Select a script...</option>');
          response.scripts.forEach(function(sc) {
            $('#script').append('<option value="' + sc.id + '">' + sc.name + ' - ' + sc.description + '</option>');
          });
        }
      });
    }
  }
  
  $('#environment').change(function() {
    filterGroups();
    filterHosts();
  });
  
  $('#group_filter').change(function() {
    filterHosts();
  });
  
  $('#os_family').change(function() {
    filterHosts();
    updatePlaybooksOrScripts();
  });
  
  // Form submission
  $('#playbookForm').submit(function(e) {
    e.preventDefault();
    console.log('Form submitted!');
    
    var formData = $(this).serialize();
    console.log('Form data:', formData);
    
    // Get execution type for dynamic messages
    var executionType = $('#execution_type').val();
    var executionLabel = executionType === 'script' ? 'Script' : 'Playbook';
    
    // Update progress title
    $('#progressTitle').html('<i class="fas fa-spinner fa-spin"></i> Executing ' + executionLabel + '...');
    
    // Show progress bar
    $('#progressArea').show();
    $('#resultArea').hide();
    
    // Simulate progress (since we can't get real-time updates from synchronous execution)
    var progress = 0;
    var progressInterval = setInterval(function() {
      progress += 5;
      if (progress <= 90) {
        $('#progressBar').css('width', progress + '%').attr('aria-valuenow', progress);
        $('#progressText').text(progress + '%');
        
        if (progress < 30) {
          $('#progressStatus').text('Connecting to host...');
        } else if (progress < 60) {
          $('#progressStatus').text('Executing ' + executionLabel.toLowerCase() + '...');
        } else {
          $('#progressStatus').text('Finalizing execution...');
        }
      }
    }, 200);
    
    $.ajax({
      url: '{% url "deploy:execute_playbook" %}',
      type: 'POST',
      data: formData,
      success: function(response) {
        // Check if this is an async execution with Celery
        if (response.async && response.task_id) {
          // Async execution - stop simulation progress and start polling
          clearInterval(progressInterval);
          $('#progressStatus').text('Execution started in background...');
          // Show and expand real-time output
          $('#realtimeOutputContainer').show();
          $('#realtimeOutput').collapse('show');
          $('#realtimeOutputContent').text('Waiting for output...\n');
          startTaskPolling(response.task_id, response.history_id);
          return;
        }
        
        clearInterval(progressInterval);
        $('#progressBar').css('width', '100%').attr('aria-valuenow', 100);
        $('#progressText').text('100%');
        $('#progressStatus').text('Completed!');
        
        setTimeout(function() {
          $('#progressArea').hide();
          $('#resultArea').show();
          
          // Check if execution was successful
          if (response.success) {
            // Check if this was a scheduled task
            if (response.scheduled) {
              $('#resultHeader').removeClass('bg-danger').addClass('bg-info text-white');
              $('#resultTitle').html('<i class="fas fa-clock"></i> Task Scheduled Successfully');
              
              $('#resultContent').html(
                '<div class="alert alert-info">' +
                '<i class="fas fa-clock"></i> <strong>Task has been scheduled!</strong>' +
                '<br><br>' +
                '<strong>Scheduled Time:</strong> ' + response.scheduled_time + '<br>' +
                '<strong>Task ID:</strong> ' + response.task_id +
                '</div>' +
                '<pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;">' +
                response.output +
                '</pre>'
              );
            } else {
              // Immediate execution
              $('#resultHeader').removeClass('bg-danger').addClass('bg-success text-white');
              $('#resultTitle').html('<i class="fas fa-check-circle"></i> ' + executionLabel + ' Executed Successfully');
              
              // Parse output to count tasks (for playbooks)
              var output = response.output || '';
              var taskMatches = output.match(/TASK \[/g);
              var taskCount = taskMatches ? taskMatches.length : 0;
              
              var successMessage = executionLabel + ' completed successfully!';
              if (executionType === 'playbook' && taskCount > 0) {
                successMessage += ' (' + taskCount + ' tasks executed)';
              }
              
              $('#resultContent').html(
                '<div class="alert alert-success">' +
                '<i class="fas fa-check-circle"></i> ' + successMessage +
                '</div>' +
                '<pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;">' +
                output +
                '</pre>'
              );
            }
          } else {
            $('#resultHeader').removeClass('bg-success').addClass('bg-danger text-white');
            $('#resultTitle').html('<i class="fas fa-exclamation-circle"></i> ' + executionLabel + ' Execution Failed');
            $('#resultContent').html(
              '<div class="alert alert-danger">' +
              '<i class="fas fa-exclamation-circle"></i> ' + (response.error || 'Execution failed') +
              '</div>' +
              '<pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;">' +
              (response.output || response.traceback || 'No output available') +
              '</pre>'
            );
          }
        }, 500);
      },
      error: function(xhr, status, error) {
        clearInterval(progressInterval);
        console.log('AJAX Error:', status, error);
        console.log('Response:', xhr.responseText);
        
        $('#progressArea').hide();
        $('#resultArea').show();
        $('#resultHeader').removeClass('bg-success').addClass('bg-danger text-white');
        $('#resultTitle').html('<i class="fas fa-exclamation-circle"></i> Communication Error');
        $('#resultContent').html(
          '<div class="alert alert-danger">' +
          '<i class="fas fa-exclamation-circle"></i> An error occurred while communicating with the server.' +
          '</div>' +
          '<p><strong>Status:</strong> ' + status + '</p>' +
          '<p><strong>Error:</strong> ' + error + '</p>' +
          '<pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;">' +
          xhr.responseText +
          '</pre>'
        );
      }
    });
  });
  
  // Initialize
  filterGroups();
  filterHosts();
});
  // Function to poll task status
  function startTaskPolling(taskId, historyId) {
    var pollInterval = 3000; // Poll every 3 seconds
    var pollCount = 0;
    var maxPolls = 1000; // Max 50 minutes (1000 * 3 seconds)
    
    function checkStatus() {
      pollCount++;
      
      // Calculate realistic progress based on time (max 50 minutes = 1000 polls)
      // Progress grows slower as it approaches 100%
      var estimatedProgress = Math.min(95, Math.floor(10 + (pollCount / maxPolls) * 85));
      $('#progressBar').css('width', estimatedProgress + '%').attr('aria-valuenow', estimatedProgress);
      $('#progressText').text(estimatedProgress + '%');
      
      $.ajax({
        url: '/deploy/history-status/' + historyId + '/',
        type: 'GET',
        success: function(data) {
          // Update progress text with elapsed time
          var elapsedMinutes = Math.floor((pollCount * 3) / 60);
          var elapsedSeconds = (pollCount * 3) % 60;
          var timeStr = elapsedMinutes + 'm ' + elapsedSeconds + 's';
          $('#progressStatus').text('Status: ' + data.status + ' - Elapsed: ' + timeStr);
          
          // Show real-time output if available
          if (data.output && data.output.trim()) {
            $('#realtimeOutputContainer').show();
            $('#realtimeOutputContent').text(data.output);
            // Auto-scroll to bottom if expanded
            var outputContainer = $('#realtimeOutput');
            if (outputContainer.hasClass('show')) {
              var pre = $('#realtimeOutputContent')[0];
              if (pre) {
                pre.scrollTop = pre.scrollHeight;
              }
            }
          }
          
          // Check if task is complete
          console.log('Checking status:', data.status, 'Task ready:', data.task_ready);
          if (data.status === 'success' || data.status === 'failed') {
            // Task completed
            console.log('Task completed! Stopping polling...');
            $('#progressBar').css('width', '100%').attr('aria-valuenow', 100);
            $('#progressText').text('100%');
            $('#progressStatus').text('Completed!');
            
            setTimeout(function() {
              $('#progressArea').hide();
              $('#resultArea').show();
              
              if (data.status === 'success') {
                $('#resultHeader').removeClass('bg-danger').addClass('bg-success text-white');
                $('#resultTitle').html('<i class="fas fa-check-circle"></i> Playbook Executed Successfully');
              } else {
                $('#resultHeader').removeClass('bg-success').addClass('bg-danger text-white');
                $('#resultTitle').html('<i class="fas fa-times-circle"></i> Execution Failed');
              }
              
              // Show output
              var output = data.output || 'No output available';
              $('#resultContent').html(
                '<pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;">' +
                output +
                '</pre>' +
                '<div class="mt-3">' +
                '<a href="/history/" class="btn btn-primary"><i class="fas fa-history"></i> View History</a> ' +
                '<button type="button" class="btn btn-secondary" onclick="location.reload()"><i class="fas fa-redo"></i> Execute Another</button>' +
                '</div>'
              );
            }, 500);
          } else if (pollCount >= maxPolls) {
            // Timeout after max polls
            clearInterval(progressInterval);
            $('#progressStatus').text('Polling timeout - task may still be running');
            $('#resultArea').show();
            $('#resultHeader').removeClass('bg-success').addClass('bg-warning text-white');
            $('#resultTitle').html('<i class="fas fa-exclamation-triangle"></i> Polling Timeout');
            $('#resultContent').html(
              '<div class="alert alert-warning">' +
              'The task is taking longer than expected. It may still be running in the background.' +
              '<br><br>' +
              '<a href="/history/" class="btn btn-primary"><i class="fas fa-history"></i> Check History</a>' +
              '</div>'
            );
          } else {
            // Continue polling
            setTimeout(checkStatus, pollInterval);
          }
        },
        error: function() {
          // On error, continue polling (maybe temporary network issue)
          if (pollCount < maxPolls) {
            setTimeout(checkStatus, pollInterval);
          }
        }
      });
    }
    
    // Start polling
    checkStatus();
  }
</script>
{% endblock %}
