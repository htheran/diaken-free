{% extends 'base/base.html' %}
{% load static %}

{% block title %}Snapshot Detail{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <h2><i class="fas fa-camera"></i> Snapshot Detail</h2>
      <a href="{% url 'snapshot_history' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to History
      </a>
      {% if snapshot.status == 'active' %}
      <button type="button" class="btn btn-danger ml-2" data-toggle="modal" data-target="#deleteSnapshotModal">
        <i class="fas fa-trash"></i> Delete Snapshot
      </button>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <i class="fas fa-info-circle"></i> Snapshot Information
        </div>
        <div class="card-body">
          <table class="table table-bordered">
            <tr>
              <th width="30%">Snapshot Name</th>
              <td>{{ snapshot.snapshot_name }}</td>
            </tr>
            <tr>
              <th>vCenter Snapshot ID</th>
              <td>{{ snapshot.vcenter_snapshot_id|default:"-" }}</td>
            </tr>
            <tr>
              <th>Description</th>
              <td>{{ snapshot.description|default:"-" }}</td>
            </tr>
            <tr>
              <th>Size</th>
              <td>{{ snapshot.size_mb }} MB</td>
            </tr>
            <tr>
              <th>Status</th>
              <td>
                {% if snapshot.status == 'active' %}
                  <span class="badge badge-success"><i class="fas fa-check-circle"></i> Active</span>
                {% elif snapshot.status == 'deleted' %}
                  <span class="badge badge-secondary"><i class="fas fa-trash"></i> Deleted</span>
                {% elif snapshot.status == 'failed' %}
                  <span class="badge badge-danger"><i class="fas fa-times-circle"></i> Failed</span>
                {% endif %}
              </td>
            </tr>
            {% if snapshot.error_message %}
            <tr>
              <th>Error Message</th>
              <td class="text-danger">{{ snapshot.error_message }}</td>
            </tr>
            {% endif %}
          </table>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header bg-info text-white">
          <i class="fas fa-clock"></i> Timing Information
        </div>
        <div class="card-body">
          <table class="table table-bordered">
            <tr>
              <th width="30%">Created At</th>
              <td>
                {{ snapshot.created_at|date:"Y-m-d H:i:s" }}
                <br>
                <small class="text-muted">{{ snapshot.created_at|timesince }} ago</small>
              </td>
            </tr>
            <tr>
              <th>Retention Period</th>
              <td>
                <span class="badge badge-info">{{ snapshot.retention_hours }} hours</span>
              </td>
            </tr>
            <tr>
              <th>Expires At</th>
              <td>
                {{ snapshot.expires_at|date:"Y-m-d H:i:s" }}
                <br>
                {% if snapshot.is_expired and snapshot.status == 'active' %}
                  <small class="text-danger"><i class="fas fa-exclamation-triangle"></i> This snapshot has expired and will be deleted soon</small>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Time Until Deletion</th>
              <td>
                {% if snapshot.status == 'active' %}
                  {% if snapshot.is_expired %}
                    <span class="badge badge-danger">Expired - Pending deletion</span>
                  {% else %}
                    <span class="badge badge-success">{{ snapshot.time_until_deletion }}</span>
                  {% endif %}
                {% else %}
                  <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            {% if snapshot.deleted_at %}
            <tr>
              <th>Deleted At</th>
              <td>
                {{ snapshot.deleted_at|date:"Y-m-d H:i:s" }}
                <br>
                <small class="text-muted">{{ snapshot.deleted_at|timesince }} ago</small>
              </td>
            </tr>
            {% endif %}
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <i class="fas fa-link"></i> Related Objects
        </div>
        <div class="card-body">
          <h6><i class="fas fa-server"></i> Host</h6>
          <p>
            <a href="/inventory/hosts/{{ snapshot.host.id }}/">
              <strong>{{ snapshot.host.name }}</strong>
            </a>
            <br>
            <small class="text-muted">IP: {{ snapshot.host.ip }}</small>
            <br>
            <small class="text-muted">Environment: {{ snapshot.host.environment.name|default:"-" }}</small>
          </p>

          <hr>

          <h6><i class="fas fa-layer-group"></i> Group</h6>
          <p>
            {% if snapshot.group %}
              <span class="badge badge-info">{{ snapshot.group.name }}</span>
            {% else %}
              <span class="text-muted">No group</span>
            {% endif %}
          </p>

          <hr>

          <h6><i class="fas fa-file-code"></i> Playbook</h6>
          <p>
            {% if snapshot.playbook %}
              <span class="badge badge-secondary">{{ snapshot.playbook.name }}</span>
            {% else %}
              <span class="text-muted">No playbook</span>
            {% endif %}
          </p>

          <hr>

          <h6><i class="fas fa-user"></i> Created By</h6>
          <p>
            {% if snapshot.user %}
              {{ snapshot.user.username }}
            {% else %}
              <span class="text-muted">System</span>
            {% endif %}
          </p>
        </div>
      </div>

      {% if snapshot.status == 'active' %}
      <div class="card mt-3">
        <div class="card-header bg-warning text-white">
          <i class="fas fa-info-circle"></i> Deletion Schedule
        </div>
        <div class="card-body">
          <p><strong>Cleanup runs every 15 minutes</strong></p>
          <p class="text-muted">
            This snapshot will be automatically deleted within 15 minutes after its expiration time.
          </p>
          <p>
            <strong>Next cleanup windows:</strong>
          </p>
          <ul class="text-muted">
            <li>:00 (on the hour)</li>
            <li>:15 (quarter past)</li>
            <li>:30 (half past)</li>
            <li>:45 (quarter to)</li>
          </ul>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Delete Snapshot Confirmation Modal -->
{% if snapshot.status == 'active' %}
<div class="modal fade" id="deleteSnapshotModal" tabindex="-1" role="dialog" aria-labelledby="deleteSnapshotModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteSnapshotModalLabel">
          <i class="fas fa-exclamation-triangle"></i> Confirm Snapshot Deletion
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Warning:</strong> This action cannot be undone!
        </div>
        <p>Are you sure you want to delete this snapshot?</p>
        <div class="card">
          <div class="card-body bg-light">
            <h5 class="mb-2">{{ snapshot.snapshot_name }}</h5>
            <p class="mb-1"><strong>Host:</strong> {{ snapshot.host.name }}</p>
            <p class="mb-1"><strong>Created:</strong> {{ snapshot.created_at|date:"Y-m-d H:i:s" }}</p>
            <p class="mb-0"><strong>Size:</strong> {{ snapshot.size_mb }} MB</p>
          </div>
        </div>
        <p class="mt-3 text-muted">
          <small>
            <i class="fas fa-info-circle"></i>
            The snapshot will be permanently deleted from vCenter and cannot be recovered.
          </small>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancel
        </button>
        <form method="post" action="{% url 'delete_snapshot' snapshot.pk %}" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash"></i> Delete Snapshot
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
