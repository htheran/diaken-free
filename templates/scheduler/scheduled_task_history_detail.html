{% extends 'base/base.html' %}
{% block title %}Scheduled Task Execution Detail{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Scheduled Task Execution Detail</h3>
      <div class="card-tools">
        <a href="{% url 'scheduled_task_history' %}" class="btn btn-sm btn-secondary">
          <i class="bi bi-arrow-left"></i> Back to History
        </a>
      </div>
    </div>
    <div class="card-body">
      <!-- Task Information -->
      <div class="row mb-4">
        <div class="col-md-6">
          <table class="table table-bordered">
            <tr>
              <th width="40%">Task Name:</th>
              <td>{{ history.scheduled_task.name }}</td>
            </tr>
            <tr>
              <th>Task Type:</th>
              <td>
                {% if history.task_type == 'host' %}
                  <span class="badge badge-info">Host</span>
                {% else %}
                  <span class="badge badge-primary">Group</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Target:</th>
              <td>{{ history.target_name }}</td>
            </tr>
            <tr>
              <th>Target IP:</th>
              <td>{{ history.target_ip|default:"-" }}</td>
            </tr>
            <tr>
              <th>Playbook:</th>
              <td>{{ history.playbook_name }}</td>
            </tr>
          </table>
        </div>
        <div class="col-md-6">
          <table class="table table-bordered">
            <tr>
              <th width="40%">Environment:</th>
              <td>{{ history.environment_name|default:"-" }}</td>
            </tr>
            <tr>
              <th>Executed At:</th>
              <td>{{ history.executed_at|date:"Y-m-d H:i:s" }}</td>
            </tr>
            <tr>
              <th>Duration:</th>
              <td>
                {% if history.execution_duration %}
                  {{ history.execution_duration }} seconds
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Status:</th>
              <td>
                {% if history.status == 'success' %}
                  <span class="badge badge-success">Success</span>
                {% else %}
                  <span class="badge badge-danger">Failed</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <th>Scheduled Task:</th>
              <td>
                <a href="{% url 'scheduled_tasks_list' %}" class="btn btn-sm btn-info">
                  View Task
                </a>
              </td>
            </tr>
          </table>
        </div>
      </div>
      
      <!-- Error Message (if failed) -->
      {% if history.error_message %}
        <div class="alert alert-danger">
          <h5><i class="bi bi-exclamation-triangle"></i> Error Message:</h5>
          <pre class="mb-0">{{ history.error_message }}</pre>
        </div>
      {% endif %}
      
      <!-- Filter Buttons -->
      <div class="mb-3" style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn btn-primary filter-btn active" data-filter="all">
          <i class="bi bi-list-ul"></i> All
        </button>
        <button class="btn btn-primary filter-btn" data-filter="tasks">
          <i class="bi bi-list-check"></i> Tasks
        </button>
        <button class="btn btn-success filter-btn" data-filter="success">
          <i class="bi bi-check-lg-circle"></i> Success (<span id="count-success">0</span>)
        </button>
        <button class="btn btn-warning filter-btn" data-filter="changed">
          <i class="bi bi-arrow-repeat-alt"></i> Changed (<span id="count-changed">0</span>)
        </button>
        <button class="btn btn-info filter-btn" data-filter="skipped">
          <i class="bi bi-forward"></i> Skipped (<span id="count-skipped">0</span>)
        </button>
        <button class="btn btn-danger filter-btn" data-filter="errors">
          <i class="bi bi-exclamation-circle"></i> Errors (<span id="count-errors">0</span>)
        </button>
      </div>
      
      <!-- Ansible Output -->
      <div class="card" id="output-card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h5 class="card-title" style="margin: 0;">Ansible Output</h5>
          <button id="expand-btn" class="btn btn-sm btn-secondary" title="Expand output">
            <i class="bi bi-expand"></i> Expand
          </button>
        </div>
        <div class="card-body p-0">
          <pre id="ansible-output" class="bg-dark text-light p-3 m-0" style="max-height: 600px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.4;">{{ history.ansible_output|default:"No output available" }}</pre>
        </div>
      </div>
      
      <style>
        #ansible-output {
          color: #e0e0e0;
        }
        .ansible-task { color: #87CEEB; font-weight: bold; }
        .ansible-play { color: #FF69B4; font-weight: bold; }
        .ansible-changed { color: #FFA500; }
        .ansible-ok { color: #90EE90; }
        .ansible-failed { color: #FF6B6B; }
        .ansible-skipped { color: #87CEEB; }
        .ansible-recap { color: #FF69B4; font-weight: bold; }
        .ansible-warning { color: #FFD700; }
        .ansible-path { color: #98C379; }
        .ansible-timestamp { color: #61AFEF; }
        
        .filter-btn {
          transition: all 0.3s ease;
        }
        .filter-btn.active {
          box-shadow: 0 0 10px rgba(0,123,255,0.5);
          transform: scale(1.05);
        }
        
        .output-line {
          display: block;
        }
        .output-line.hidden {
          display: none !important;
        }
        
        /* Fullscreen styles */
        #output-card.fullscreen {
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          z-index: 9999;
          margin: 0;
          border-radius: 0;
        }
        
        #output-card.fullscreen .card-body {
          height: calc(100vh - 60px);
        }
        
        #output-card.fullscreen #ansible-output {
          max-height: 100%;
          height: 100%;
        }
      </style>
      
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const output = document.getElementById('ansible-output');
          if (!output) return;
          
          let html = output.innerHTML;
          let lines = html.split('\n');
          let processedLines = [];
          
          // Counters
          let counts = {
            success: 0,
            changed: 0,
            skipped: 0,
            errors: 0
          };
          
          // Process each line
          lines.forEach((line, index) => {
            let lineClass = 'output-line';
            let lineType = '';
            
            // Detect line type
            if (line.match(/TASK \[/)) {
              lineType = 'task';
              line = line.replace(/TASK \[(.*?)\]/g, '<span class="ansible-task">TASK [$1]</span>');
            } else if (line.match(/PLAY \[/)) {
              lineType = 'play';
              line = line.replace(/PLAY \[(.*?)\]/g, '<span class="ansible-play">PLAY [$1]</span>');
            } else if (line.match(/PLAY RECAP/)) {
              lineType = 'recap';
              line = line.replace(/PLAY RECAP (\*+)/g, '<span class="ansible-recap">PLAY RECAP $1</span>');
            } else if (line.match(/changed: \[/)) {
              lineType = 'changed';
              counts.changed++;
              line = line.replace(/changed: \[(.*?)\]/g, '<span class="ansible-changed">changed: [$1]</span>');
            } else if (line.match(/ok: \[/)) {
              lineType = 'success';
              counts.success++;
              line = line.replace(/ok: \[(.*?)\]/g, '<span class="ansible-ok">ok: [$1]</span>');
            } else if (line.match(/failed: \[|fatal: \[|FAILED!/)) {
              lineType = 'error';
              counts.errors++;
              line = line.replace(/failed: \[(.*?)\]/g, '<span class="ansible-failed">failed: [$1]</span>');
              line = line.replace(/fatal: \[(.*?)\]/g, '<span class="ansible-failed">fatal: [$1]</span>');
            } else if (line.match(/skipping: \[/)) {
              lineType = 'skipped';
              counts.skipped++;
              line = line.replace(/skipping: \[(.*?)\]/g, '<span class="ansible-skipped">skipping: [$1]</span>');
            }
            
            // Color summary numbers
            line = line.replace(/changed=(\d+)/g, '<span class="ansible-changed">changed=$1</span>');
            line = line.replace(/ok=(\d+)/g, '<span class="ansible-ok">ok=$1</span>');
            line = line.replace(/failed=(\d+)/g, '<span class="ansible-failed">failed=$1</span>');
            line = line.replace(/skipped=(\d+)/g, '<span class="ansible-skipped">skipped=$1</span>');
            line = line.replace(/unreachable=(\d+)/g, '<span class="ansible-failed">unreachable=$1</span>');
            
            // Color paths
            line = line.replace(/task path: (.*?)$/gm, 'task path: <span class="ansible-path">$1</span>');
            
            // Color timestamps
            line = line.replace(/\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/g, '[<span class="ansible-timestamp">$1</span>]');
            
            processedLines.push(`<span class="${lineClass}" data-type="${lineType}">${line}</span>`);
          });
          
          output.innerHTML = processedLines.join('\n');
          
          // Update counters
          document.getElementById('count-success').textContent = counts.success;
          document.getElementById('count-changed').textContent = counts.changed;
          document.getElementById('count-skipped').textContent = counts.skipped;
          document.getElementById('count-errors').textContent = counts.errors;
          
          // Filter functionality
          const filterButtons = document.querySelectorAll('.filter-btn');
          const outputLines = document.querySelectorAll('.output-line');
          
          filterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
              const filter = this.dataset.filter;
              
              // Update active button
              filterButtons.forEach(b => b.classList.remove('active'));
              this.classList.add('active');
              
              // Filter lines
              outputLines.forEach(line => {
                const lineType = line.dataset.type;
                
                if (filter === 'all') {
                  line.classList.remove('hidden');
                } else if (filter === 'tasks') {
                  if (lineType === 'task' || lineType === 'play' || lineType === 'recap') {
                    line.classList.remove('hidden');
                  } else {
                    line.classList.add('hidden');
                  }
                } else if (filter === 'success') {
                  if (lineType === 'success') {
                    line.classList.remove('hidden');
                  } else {
                    line.classList.add('hidden');
                  }
                } else if (filter === 'changed') {
                  if (lineType === 'changed') {
                    line.classList.remove('hidden');
                  } else {
                    line.classList.add('hidden');
                  }
                } else if (filter === 'skipped') {
                  if (lineType === 'skipped') {
                    line.classList.remove('hidden');
                  } else {
                    line.classList.add('hidden');
                  }
                } else if (filter === 'errors') {
                  if (lineType === 'error') {
                    line.classList.remove('hidden');
                  } else {
                    line.classList.add('hidden');
                  }
                }
              });
            });
          });
          
          // Expand/Collapse functionality
          const expandBtn = document.getElementById('expand-btn');
          const outputCard = document.getElementById('output-card');
          
          expandBtn.addEventListener('click', function() {
            outputCard.classList.toggle('fullscreen');
            
            if (outputCard.classList.contains('fullscreen')) {
              expandBtn.innerHTML = '<i class="bi bi-compress"></i> Collapse';
              expandBtn.title = 'Collapse output';
            } else {
              expandBtn.innerHTML = '<i class="bi bi-expand"></i> Expand';
              expandBtn.title = 'Expand output';
            }
          });
          
          // ESC key to exit fullscreen
          document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && outputCard.classList.contains('fullscreen')) {
              outputCard.classList.remove('fullscreen');
              expandBtn.innerHTML = '<i class="bi bi-expand"></i> Expand';
              expandBtn.title = 'Expand output';
            }
          });
        });
      </script>
    </div>
  </div>
</div>
{% endblock %}
