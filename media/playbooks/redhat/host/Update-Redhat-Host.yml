---
- name: Complete Linux System Update (RHEL/Oracle Linux/Rocky)
  hosts: target_host
  become: yes
  gather_facts: yes
  vars:
    log_dir: "/var/log/ansible_updates"
    report_dir: "/var/log/ansible_updates/reports"

  tasks:

    # ============================================================================
    # PREPARATION: Create directories and get system information
    # ============================================================================

    - name: Create log directory
      file:
        path: "{{ log_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create reports directory
      file:
        path: "{{ report_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Get server hostname
      command: hostname
      register: hostname_result
      changed_when: false

    - name: Get current date and time
      command: date +%Y%m%d_%H%M%S
      register: datetime_result
      changed_when: false

    - name: Define report file names
      set_fact:
        report_before: "{{ report_dir }}/{{ hostname_result.stdout }}_{{ datetime_result.stdout }}_BEFORE.txt"
        report_after: "{{ report_dir }}/{{ hostname_result.stdout }}_{{ datetime_result.stdout }}_AFTER.txt"
        log_file: "{{ log_dir }}/update_{{ datetime_result.stdout }}.log"

    # ============================================================================
    # INITIAL REPORT: Complete diagnostic BEFORE updating
    # ============================================================================

    - name: Generate initial complete report (BEFORE)
      shell: |
        echo "================================================================================" > {{ report_before }}
        echo "INITIAL REPORT - COMPLETE DIAGNOSTIC BEFORE UPDATING" >> {{ report_before }}
        echo "================================================================================" >> {{ report_before }}
        echo "" >> {{ report_before }}
        echo "Server: $(hostname)" >> {{ report_before }}
        echo "Date/Time: $(date '+%Y-%m-%d %H:%M:%S')" >> {{ report_before }}
        echo "User: $(whoami)" >> {{ report_before }}
        echo "System: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'\"' -f2)" >> {{ report_before }}
        echo "Kernel: $(uname -r)" >> {{ report_before }}
        echo "Architecture: $(uname -m)" >> {{ report_before }}
        echo "Last reboot: $(uptime -s)" >> {{ report_before }}
        echo "Uptime: $(uptime -p)" >> {{ report_before }}
        echo "" >> {{ report_before }}
        
        echo "--------------------------------------------------------------------------------" >> {{ report_before }}
        echo "MEMORY INFORMATION:" >> {{ report_before }}
        echo "--------------------------------------------------------------------------------" >> {{ report_before }}
        free -h >> {{ report_before }}
        echo "" >> {{ report_before }}
        
        echo "--------------------------------------------------------------------------------" >> {{ report_before }}
        echo "DISK SPACE:" >> {{ report_before }}
        echo "--------------------------------------------------------------------------------" >> {{ report_before }}
        df -h >> {{ report_before }}
        echo "" >> {{ report_before }}
        
        echo "--------------------------------------------------------------------------------" >> {{ report_before }}
        echo "CURRENTLY INSTALLED PACKAGES (last 20):" >> {{ report_before }}
        echo "--------------------------------------------------------------------------------" >> {{ report_before }}
        rpm -qa --last | head -20 >> {{ report_before }}
        echo "" >> {{ report_before }}
        echo "Total installed packages: $(rpm -qa | wc -l)" >> {{ report_before }}
        echo "" >> {{ report_before }}
        
        echo "--------------------------------------------------------------------------------" >> {{ report_before }}
        echo "CURRENT KERNEL VERSION:" >> {{ report_before }}
        echo "--------------------------------------------------------------------------------" >> {{ report_before }}
        uname -a >> {{ report_before }}
        echo "" >> {{ report_before }}
        echo "Installed kernels:" >> {{ report_before }}
        rpm -qa | grep kernel | sort >> {{ report_before }}
        echo "" >> {{ report_before }}
        
        echo "--------------------------------------------------------------------------------" >> {{ report_before }}
        echo "CRITICAL SERVICES RUNNING:" >> {{ report_before }}
        echo "--------------------------------------------------------------------------------" >> {{ report_before }}
        systemctl list-units --type=service --state=running --no-pager >> {{ report_before }}
        echo "" >> {{ report_before }}
        
        echo "--------------------------------------------------------------------------------" >> {{ report_before }}
        echo "CONFIGURED REPOSITORIES:" >> {{ report_before }}
        echo "--------------------------------------------------------------------------------" >> {{ report_before }}
        dnf repolist >> {{ report_before }}
        echo "" >> {{ report_before }}
        
        echo "================================================================================" >> {{ report_before }}
        echo "SEARCHING FOR AVAILABLE UPDATES..." >> {{ report_before }}
        echo "================================================================================" >> {{ report_before }}
        echo "" >> {{ report_before }}
      args:
        executable: /bin/bash
      changed_when: false

    - name: Check for available updates (check-update)
      command: dnf check-update
      register: check_updates
      changed_when: false
      failed_when: false

    - name: Count available updates
      shell: |
        if [ {{ check_updates.rc }} -eq 100 ]; then
          # RC 100 means updates are available
          echo "{{ check_updates.stdout }}" | grep -v "^$" | grep -v "^Last metadata" | grep -v "^Ãšltima" | wc -l
        else
          echo "0"
        fi
      register: update_count
      changed_when: false

    - name: Save detailed list of available updates
      shell: |
        if [ {{ check_updates.rc }} -eq 100 ]; then
          echo "âœ— Total: {{ update_count.stdout }} UPDATES AVAILABLE" >> {{ report_before }}
          echo "" >> {{ report_before }}
          echo "Detailed list of packages to update:" >> {{ report_before }}
          echo "{{ check_updates.stdout }}" >> {{ report_before }}
          echo "" >> {{ report_before }}
          
          # Separate by type
          echo "--------------------------------------------------------------------------------" >> {{ report_before }}
          echo "SECURITY UPDATES:" >> {{ report_before }}
          echo "--------------------------------------------------------------------------------" >> {{ report_before }}
          dnf updateinfo list security 2>/dev/null | grep -v "^Last metadata" | grep -v "^Ãšltima" >> {{ report_before }} || echo "Could not retrieve security information" >> {{ report_before }}
          echo "" >> {{ report_before }}
          
          echo "--------------------------------------------------------------------------------" >> {{ report_before }}
          echo "BUGFIX UPDATES:" >> {{ report_before }}
          echo "--------------------------------------------------------------------------------" >> {{ report_before }}
          dnf updateinfo list bugfix 2>/dev/null | grep -v "^Last metadata" | grep -v "^Ãšltima" | head -20 >> {{ report_before }} || echo "Could not retrieve bugfix information" >> {{ report_before }}
          echo "" >> {{ report_before }}
        else
          echo "âœ“ No updates available" >> {{ report_before }}
          echo "" >> {{ report_before }}
        fi
        
        echo "================================================================================" >> {{ report_before }}
        echo "END OF INITIAL REPORT" >> {{ report_before }}
        echo "================================================================================" >> {{ report_before }}
      args:
        executable: /bin/bash
      changed_when: false

    - name: Display summary when no updates available
      debug:
        msg:
          - "================================================================================"
          - "SYSTEM UPDATE CHECK - {{ hostname_result.stdout }}"
          - "================================================================================"
          - "Date/Time: {{ ansible_date_time.iso8601 }}"
          - "System: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Kernel: {{ ansible_kernel }}"
          - ""
          - "âœ“ No updates available - System is up to date"
          - ""
          - "Full diagnostic report saved to: {{ report_before }}"
          - "================================================================================"
      when: check_updates.rc != 100

    - name: Display initial report in console
      command: cat {{ report_before }}
      register: initial_report
      changed_when: false
      when: check_updates.rc == 100

    - name: Print initial report
      debug:
        msg: "{{ initial_report.stdout_lines }}"
      when: check_updates.rc == 100

    # ============================================================================
    # UPDATE: Apply updates with DNF
    # ============================================================================

    - name: Apply all available updates
      dnf:
        name: "*"
        state: latest
        update_cache: yes
      register: update_result
      async: 3600
      poll: 30
      when: check_updates.rc == 100

    - name: Log no updates needed
      shell: |
        echo "" > {{ log_file }}
        echo "================================================================================" >> {{ log_file }}
        echo "UPDATE CHECK RESULT" >> {{ log_file }}
        echo "================================================================================" >> {{ log_file }}
        echo "Date/Time: $(date '+%Y-%m-%d %H:%M:%S')" >> {{ log_file }}
        echo "" >> {{ log_file }}
        echo "âœ“ No updates available - System is already up to date" >> {{ log_file }}
        echo "" >> {{ log_file }}
        echo "================================================================================" >> {{ log_file }}
      args:
        executable: /bin/bash
      changed_when: false
      when: check_updates.rc != 100

    - name: Save update result to log
      shell: |
        echo "" > {{ log_file }}
        echo "================================================================================" >> {{ log_file }}
        echo "UPDATE RESULT" >> {{ log_file }}
        echo "================================================================================" >> {{ log_file }}
        echo "Date/Time: $(date '+%Y-%m-%d %H:%M:%S')" >> {{ log_file }}
        echo "" >> {{ log_file }}
        
        if [ "{{ update_result.changed }}" = "True" ]; then
          echo "âœ“ UPDATES APPLIED SUCCESSFULLY" >> {{ log_file }}
          echo "" >> {{ log_file }}
          echo "Updated packages:" >> {{ log_file }}
          echo "{{ update_result.changes | default('') }}" >> {{ log_file }}
        else
          echo "âœ“ No changes applied (system already up to date)" >> {{ log_file }}
        fi
        echo "" >> {{ log_file }}
        echo "================================================================================" >> {{ log_file }}
      args:
        executable: /bin/bash
      changed_when: false
      when: check_updates.rc == 100

    # ============================================================================
    # REBOOT: Restart server if necessary
    # ============================================================================

    - name: Set no reboot needed when no updates
      set_fact:
        needs_reboot: false
      when: check_updates.rc != 100

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required_file
      when: check_updates.rc == 100

    - name: Check if there are processes requiring restart (needs-restarting)
      command: needs-restarting -r
      register: needs_restart
      failed_when: false
      changed_when: false
      when: check_updates.rc == 100

    - name: Register reboot requirement
      set_fact:
        needs_reboot: "{{ needs_restart.rc == 1 or reboot_required_file.stat.exists }}"
      when: check_updates.rc == 100

    - name: Notify about reboot
      debug:
        msg: |
          {% if needs_reboot %}
          âš  REBOOT REQUIRED: The system needs to restart to fully apply the updates.
          Server will reboot in 30 seconds...
          {% else %}
          âœ“ System reboot not required.
          {% endif %}

    - name: Reboot server if necessary
      reboot:
        msg: "Rebooting server to apply system updates"
        pre_reboot_delay: 30
        post_reboot_delay: 30
        reboot_timeout: 600
      when: needs_reboot

    # ============================================================================
    # FINAL REPORT: Complete diagnostic AFTER updating
    # ============================================================================

    - name: Display completion summary when no updates
      debug:
        msg:
          - "================================================================================"
          - "UPDATE PROCESS COMPLETED"
          - "================================================================================"
          - ""
          - "âœ“ Status: No updates were needed"
          - "- Reboot: Not required"
          - ""
          - "Report files:"
          - "  - Diagnostic report: {{ report_before }}"
          - "  - Update log: {{ log_file }}"
          - ""
          - "================================================================================"
      when: check_updates.rc != 100

    - name: Generate final complete report (AFTER)
      shell: |
        echo "================================================================================" > {{ report_after }}
        echo "FINAL REPORT - COMPLETE DIAGNOSTIC AFTER UPDATING" >> {{ report_after }}
        echo "================================================================================" >> {{ report_after }}
        echo "" >> {{ report_after }}
        echo "Server: $(hostname)" >> {{ report_after }}
        echo "Date/Time: $(date '+%Y-%m-%d %H:%M:%S')" >> {{ report_after }}
        echo "System: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'\"' -f2)" >> {{ report_after }}
        echo "Kernel: $(uname -r)" >> {{ report_after }}
        echo "Last reboot: $(uptime -s)" >> {{ report_after }}
        echo "Uptime: $(uptime -p)" >> {{ report_after }}
        echo "" >> {{ report_after }}
        
        echo "--------------------------------------------------------------------------------" >> {{ report_after }}
        echo "MEMORY INFORMATION (AFTER):" >> {{ report_after }}
        echo "--------------------------------------------------------------------------------" >> {{ report_after }}
        free -h >> {{ report_after }}
        echo "" >> {{ report_after }}
        
        echo "--------------------------------------------------------------------------------" >> {{ report_after }}
        echo "DISK SPACE (AFTER):" >> {{ report_after }}
        echo "--------------------------------------------------------------------------------" >> {{ report_after }}
        df -h >> {{ report_after }}
        echo "" >> {{ report_after }}
        
        echo "--------------------------------------------------------------------------------" >> {{ report_after }}
        echo "RECENTLY INSTALLED PACKAGES (last 30):" >> {{ report_after }}
        echo "--------------------------------------------------------------------------------" >> {{ report_after }}
        rpm -qa --last | head -30 >> {{ report_after }}
        echo "" >> {{ report_after }}
        echo "Total installed packages: $(rpm -qa | wc -l)" >> {{ report_after }}
        echo "" >> {{ report_after }}
        
        echo "--------------------------------------------------------------------------------" >> {{ report_after }}
        echo "KERNEL VERSION (AFTER):" >> {{ report_after }}
        echo "--------------------------------------------------------------------------------" >> {{ report_after }}
        uname -a >> {{ report_after }}
        echo "" >> {{ report_after }}
        echo "Installed kernels:" >> {{ report_after }}
        rpm -qa | grep kernel | sort >> {{ report_after }}
        echo "" >> {{ report_after }}
        
        echo "--------------------------------------------------------------------------------" >> {{ report_after }}
        echo "CRITICAL SERVICES RUNNING (AFTER):" >> {{ report_after }}
        echo "--------------------------------------------------------------------------------" >> {{ report_after }}
        systemctl list-units --type=service --state=running --no-pager >> {{ report_after }}
        echo "" >> {{ report_after }}
        
        echo "--------------------------------------------------------------------------------" >> {{ report_after }}
        echo "UPDATE HISTORY (last 50):" >> {{ report_after }}
        echo "--------------------------------------------------------------------------------" >> {{ report_after }}
        dnf history list | head -50 >> {{ report_after }}
        echo "" >> {{ report_after }}
        
        echo "================================================================================" >> {{ report_after }}
        echo "FINAL VERIFICATION - PENDING UPDATES" >> {{ report_after }}
        echo "================================================================================" >> {{ report_after }}
        echo "" >> {{ report_after }}
      args:
        executable: /bin/bash
      changed_when: false
      when: check_updates.rc == 100

    - name: Check if there are remaining pending updates
      command: dnf check-update
      register: final_check
      changed_when: false
      failed_when: false
      when: check_updates.rc == 100

    - name: Count final pending updates
      shell: |
        if [ {{ final_check.rc }} -eq 100 ]; then
          echo "{{ final_check.stdout }}" | grep -v "^$" | grep -v "^Last metadata" | grep -v "^Ãšltima" | wc -l
        else
          echo "0"
        fi
      register: final_update_count
      changed_when: false
      when: check_updates.rc == 100

    - name: Save final update verification
      shell: |
        if [ {{ final_check.rc }} -eq 100 ]; then
          echo "âš  WARNING: {{ final_update_count.stdout }} updates still pending" >> {{ report_after }}
          echo "" >> {{ report_after }}
          echo "Pending updates:" >> {{ report_after }}
          echo "{{ final_check.stdout }}" >> {{ report_after }}
          echo "" >> {{ report_after }}
          echo "NOTE: Some updates may require manual intervention." >> {{ report_after }}
        else
          echo "âœ“ SYSTEM FULLY UPDATED" >> {{ report_after }}
          echo "" >> {{ report_after }}
          echo "No pending updates." >> {{ report_after }}
        fi
        echo "" >> {{ report_after }}
        
        echo "================================================================================" >> {{ report_after }}
        echo "UPDATE SUMMARY" >> {{ report_after }}
        echo "================================================================================" >> {{ report_after }}
        echo "" >> {{ report_after }}
        
        if [ "{{ update_result.changed }}" = "True" ]; then
          echo "âœ“ Status: UPDATES APPLIED SUCCESSFULLY" >> {{ report_after }}
        else
          echo "âœ“ Status: SYSTEM WAS ALREADY UP TO DATE" >> {{ report_after }}
        fi
        
        if [ "{{ needs_reboot }}" = "True" ]; then
          echo "âœ“ Reboot: EXECUTED" >> {{ report_after }}
        else
          echo "- Reboot: NOT REQUIRED" >> {{ report_after }}
        fi
        
        echo "" >> {{ report_after }}
        echo "Generated report files:" >> {{ report_after }}
        echo "  - BEFORE Report:  {{ report_before }}" >> {{ report_after }}
        echo "  - AFTER Report: {{ report_after }}" >> {{ report_after }}
        echo "  - Update log: {{ log_file }}" >> {{ report_after }}
        echo "" >> {{ report_after }}
        
        echo "================================================================================" >> {{ report_after }}
        echo "END OF FINAL REPORT" >> {{ report_after }}
        echo "================================================================================" >> {{ report_after }}
      args:
        executable: /bin/bash
      changed_when: false
      when: check_updates.rc == 100

    - name: Display final report in console
      command: cat {{ report_after }}
      register: final_report
      changed_when: false
      when: check_updates.rc == 100

    - name: Print final report
      debug:
        msg: "{{ final_report.stdout_lines }}"
      when: check_updates.rc == 100

    - name: Display report locations
      debug:
        msg:
          - "================================================================================"
          - "REPORTS GENERATED SUCCESSFULLY"
          - "================================================================================"
          - ""
          - "The following files have been created on the server:"
          - ""
          - "  ðŸ“„ BEFORE update report:"
          - "     {{ report_before }}"
          - ""
          - "  ðŸ“„ AFTER update report:"
          - "     {{ report_after }}"
          - ""
          - "  ðŸ“„ Update log:"
          - "     {{ log_file }}"
          - ""
          - "You can download these files for further analysis."
          - "================================================================================"
      when: check_updates.rc == 100
