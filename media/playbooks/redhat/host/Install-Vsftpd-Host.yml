---
# Install and Configure vsftpd (FTP Server)
# This playbook installs and configures vsftpd on RedHat-based systems

- name: Install and Configure vsftpd
  hosts: target_host
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Display hostname
      debug:
        msg: "Installing vsftpd on: {{ inventory_hostname }}"
    
    - name: Install vsftpd package
      dnf:
        name: vsftpd
        state: present
      when: ansible_os_family == "RedHat"
    
    - name: Configure vsftpd
      lineinfile:
        path: /etc/vsftpd/vsftpd.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: '^anonymous_enable=', line: 'anonymous_enable=NO' }
        - { regexp: '^local_enable=', line: 'local_enable=YES' }
        - { regexp: '^write_enable=', line: 'write_enable=YES' }
        - { regexp: '^chroot_local_user=', line: 'chroot_local_user=YES' }
        - { regexp: '^allow_writeable_chroot=', line: 'allow_writeable_chroot=YES' }
      when: ansible_os_family == "RedHat"
    
    - name: Start and enable vsftpd service
      systemd:
        name: vsftpd
        state: started
        enabled: yes
      when: ansible_os_family == "RedHat"
    
    - name: Open firewall for FTP
      firewalld:
        service: ftp
        permanent: yes
        state: enabled
        immediate: yes
      when: ansible_os_family == "RedHat"
      ignore_errors: yes
    
    - name: Set SELinux boolean for FTP home directories
      seboolean:
        name: ftp_home_dir
        state: yes
        persistent: yes
      when:
        - ansible_os_family == "RedHat"
        - ansible_selinux.status == "enabled"
      ignore_errors: yes
    
    - name: Display success message
      debug:
        msg: "âœ… vsftpd installed and configured successfully"
    
    - name: Display FTP access information
      debug:
        msg: |
          FTP Server is now running on {{ inventory_hostname }}
          Connect using: ftp://{{ ansible_default_ipv4.address | default(inventory_hostname) }}
          Use local system users for authentication
