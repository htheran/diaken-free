---
- name: Instalación y configuración de servidor web Apache2 (Debian/Ubuntu)
  hosts: target_host
  become: yes

  vars:
    ansible_remote_tmp: /tmp/.ansible/tmp
    # Todas las variables vienen de Global Settings (Apache Variables):
    # - debian_apache_user
    # - debian_apache_group
    # - debian_server_root
    # - debian_log_root
    # - debian_http_port

  tasks:

    # =====================================================================
    # Preparación básica
    # =====================================================================
    - name: Asegurar /tmp/.ansible/tmp existe y tiene permisos correctos
      ansible.builtin.file:
        path: /tmp/.ansible/tmp
        state: directory
        mode: '1777'
      tags: [ansible_tmp, preparation]

    - name: Cambiar el hostname del sistema
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"
      tags: [hostname, preparation]

    - name: Actualizar cache de paquetes
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      environment:
        DEBIAN_FRONTEND: noninteractive
      tags: [preparation, system_update]

    # =====================================================================
    # Instalación de Apache2
    # =====================================================================
    - name: Instalar Apache2 y módulos esenciales
      ansible.builtin.apt:
        name:
          - apache2
          - apache2-utils
        state: present
      environment:
        DEBIAN_FRONTEND: noninteractive
      tags: [httpd, installation]

    - name: Asegurar que el servicio apache2 esté iniciado y habilitado
      ansible.builtin.service:
        name: apache2
        state: started
        enabled: true
      tags: [httpd, service]

    # =====================================================================
    # Configuración de firewall (UFW) - Opcional
    # =====================================================================
    - name: Recolectar información de paquetes instalados
      ansible.builtin.package_facts:
        manager: auto
      tags: [firewall]

    - name: Configurar firewall UFW (si está instalado)
      block:
        - name: Permitir puerto HTTP
          community.general.ufw:
            rule: allow
            port: "{{ debian_http_port }}"
            proto: tcp
          when: "'ufw' in ansible_facts.packages"

        - name: Permitir puerto HTTPS (443)
          community.general.ufw:
            rule: allow
            port: '443'
            proto: tcp
          when: "'ufw' in ansible_facts.packages"
      ignore_errors: true
      tags: [firewall]

    # =====================================================================
    # Estructura de directorios
    # =====================================================================
    - name: Asegurar estructura de directorios base
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      loop:
        - "{{ debian_server_root }}"
        - "{{ debian_log_root }}"
      tags: [httpd, directories]

    - name: Crear directorio del host para sitios web
      ansible.builtin.file:
        path: "{{ debian_server_root }}/{{ inventory_hostname }}"
        state: directory
        mode: '0775'
        owner: "{{ debian_apache_user }}"
        group: "{{ debian_apache_group }}"
      tags: [httpd, directories]

    - name: Crear directorio de logs del host
      ansible.builtin.file:
        path: "{{ debian_log_root }}/{{ inventory_hostname }}"
        state: directory
        mode: '0775'
        owner: "{{ debian_apache_user }}"
        group: "{{ debian_apache_group }}"
      tags: [httpd, directories]

    # =====================================================================
    # Página de inicio por defecto
    # =====================================================================
    - name: Crear página de inicio por defecto
      ansible.builtin.copy:
        content: |
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>{{ inventory_hostname }} - Apache2</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      padding: 20px;
                  }
                  .container {
                      background: white;
                      border-radius: 15px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                      padding: 40px;
                      max-width: 600px;
                      width: 100%;
                  }
                  h1 {
                      color: #667eea;
                      margin-bottom: 20px;
                      font-size: 2em;
                      text-align: center;
                  }
                  .success {
                      background: #d4edda;
                      border-left: 4px solid #28a745;
                      padding: 15px;
                      margin-bottom: 20px;
                      border-radius: 5px;
                  }
                  .info {
                      background: #f8f9fa;
                      padding: 20px;
                      border-radius: 8px;
                      margin-top: 20px;
                  }
                  .info-item {
                      display: flex;
                      padding: 10px 0;
                      border-bottom: 1px solid #dee2e6;
                  }
                  .info-item:last-child { border-bottom: none; }
                  .info-label {
                      font-weight: bold;
                      color: #495057;
                      min-width: 140px;
                  }
                  .info-value {
                      color: #6c757d;
                      word-break: break-all;
                  }
                  .footer {
                      text-align: center;
                      margin-top: 30px;
                      color: #6c757d;
                      font-size: 0.9em;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>✓ Apache2 Instalado</h1>
                  <div class="success">
                      <strong>¡Éxito!</strong> El servidor web Apache2 se ha instalado y configurado correctamente.
                  </div>
                  <div class="info">
                      <div class="info-item">
                          <span class="info-label">Hostname:</span>
                          <span class="info-value">{{ inventory_hostname }}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">Sistema:</span>
                          <span class="info-value">Debian/Ubuntu</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">Servidor web:</span>
                          <span class="info-value">Apache2</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">Directorio:</span>
                          <span class="info-value">{{ debian_server_root }}/{{ inventory_hostname }}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">Usuario:</span>
                          <span class="info-value">{{ debian_apache_user }}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">Logs:</span>
                          <span class="info-value">{{ debian_log_root }}/{{ inventory_hostname }}</span>
                      </div>
                      <div class="info-item">
                          <span class="info-label">Puerto:</span>
                          <span class="info-value">{{ debian_http_port }}</span>
                      </div>
                  </div>
                  <div class="footer">
                      Configurado automáticamente por Diaken
                  </div>
              </div>
          </body>
          </html>
        dest: "{{ debian_server_root }}/{{ inventory_hostname }}/index.html"
        owner: "{{ debian_apache_user }}"
        group: "{{ debian_apache_group }}"
        mode: '0664'
      tags: [httpd, content]

    # =====================================================================
    # Configuración de VirtualHost usando contenido inline
    # =====================================================================
    - name: Crear configuración de VirtualHost
      ansible.builtin.copy:
        content: |
          # VirtualHost Configuration for {{ inventory_hostname }}
          # Generated by Ansible
          
          <VirtualHost *:{{ debian_http_port }}>
              ServerName {{ inventory_hostname }}
              ServerAdmin webmaster@{{ inventory_hostname }}
              
              # Document Root
              DocumentRoot {{ debian_server_root }}/{{ inventory_hostname }}
              
              # Directory Configuration
              <Directory {{ debian_server_root }}/{{ inventory_hostname }}>
                  Options -Indexes +FollowSymLinks +MultiViews
                  AllowOverride All
                  Require all granted
                  
                  # Security Headers
                  Header always set X-Frame-Options "SAMEORIGIN"
                  Header always set X-Content-Type-Options "nosniff"
                  Header always set X-XSS-Protection "1; mode=block"
                  Header always set Referrer-Policy "strict-origin-when-cross-origin"
              </Directory>
              
              # Logging
              ErrorLog {{ debian_log_root }}/{{ inventory_hostname }}/error.log
              CustomLog {{ debian_log_root }}/{{ inventory_hostname }}/access.log combined
              
              # PHP Configuration (si está instalado)
              <IfModule mod_php7.c>
                  php_admin_value upload_max_filesize 64M
                  php_admin_value post_max_size 64M
                  php_admin_value max_execution_time 300
                  php_admin_value max_input_time 300
              </IfModule>
              
              # Compression
              <IfModule mod_deflate.c>
                  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
              </IfModule>
              
              # Browser Caching
              <IfModule mod_expires.c>
                  ExpiresActive On
                  ExpiresByType image/jpg "access plus 1 year"
                  ExpiresByType image/jpeg "access plus 1 year"
                  ExpiresByType image/gif "access plus 1 year"
                  ExpiresByType image/png "access plus 1 year"
                  ExpiresByType image/svg+xml "access plus 1 year"
                  ExpiresByType text/css "access plus 1 month"
                  ExpiresByType application/javascript "access plus 1 month"
                  ExpiresByType application/pdf "access plus 1 month"
                  ExpiresByType text/x-javascript "access plus 1 month"
              </IfModule>
          </VirtualHost>
        dest: "/etc/apache2/sites-available/{{ inventory_hostname }}.conf"
        owner: root
        group: root
        mode: '0644'
      tags: [httpd, vhost]

    - name: Habilitar módulos de Apache necesarios
      ansible.builtin.command:
        cmd: "a2enmod {{ item }}"
      loop:
        - rewrite
        - headers
        - expires
        - deflate
      register: apache_mods
      changed_when: "'already enabled' not in apache_mods.stdout"
      tags: [httpd, modules]

    - name: Deshabilitar sitio por defecto
      ansible.builtin.command:
        cmd: a2dissite 000-default
      register: disable_default
      changed_when: "'already disabled' not in disable_default.stdout"
      ignore_errors: true
      tags: [httpd, vhost]

    - name: Habilitar VirtualHost del host
      ansible.builtin.command:
        cmd: "a2ensite {{ inventory_hostname }}.conf"
      register: enable_vhost
      changed_when: "'already enabled' not in enable_vhost.stdout"
      tags: [httpd, vhost]

    # =====================================================================
    # Verificación y reinicio
    # =====================================================================
    - name: Verificar sintaxis de Apache
      ansible.builtin.command: apache2ctl configtest
      register: apache_test
      failed_when: false
      changed_when: false
      tags: [httpd, verification]

    - name: Mostrar resultado de verificación
      ansible.builtin.debug:
        msg: "{{ apache_test.stdout_lines }}"
      tags: [httpd, verification]

    - name: Reiniciar Apache si la configuración es válida
      ansible.builtin.service:
        name: apache2
        state: restarted
      when: apache_test.rc == 0
      tags: [httpd, service]

    - name: Verificar que Apache esté escuchando en el puerto configurado
      ansible.builtin.wait_for:
        port: "{{ debian_http_port }}"
        timeout: 10
      tags: [httpd, verification]

    # =====================================================================
    # Mensaje final
    # =====================================================================
    - name: Mostrar información de finalización
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Apache2 instalado y configurado exitosamente"
          - "=========================================="
          - "Sitio web: http://{{ inventory_hostname }}"
          - "Directorio: {{ debian_server_root }}/{{ inventory_hostname }}"
          - "Logs: {{ debian_log_root }}/{{ inventory_hostname }}"
          - "Usuario: {{ debian_apache_user }}"
          - "Puerto: {{ debian_http_port }}"
          - "=========================================="
      tags: [summary]
