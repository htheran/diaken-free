---
- name: Configurar HTTPS con mod_ssl (Grupo)
  hosts: target_group
  become: yes

  vars:
    subdomain: "{{ inventory_hostname }}"
    # Usar variables pasadas desde Django en lugar de valores hardcodeados
    domain: "{{ domain }}"
    server_root: "{{ server_root }}"
    log_root: "{{ log_root }}"
    http_port: "{{ http_port }}"
    https_port: "{{ https_port }}"
    # Nombre del certificado SSL (debe coincidir con el nombre en Settings → SSL Certificates)
    # Si no se especifica ssl_cert_name, usará la variable domain por defecto
    # Ejemplo: si el certificado se llama "example.com", los archivos estarán en:
    # /opt/www/app/diaken-pdn/media/ssl/example.com/certificado.crt
    # /opt/www/app/diaken-pdn/media/ssl/example.com/certificado.key
    # /opt/www/app/diaken-pdn/media/ssl/example.com/certificado-provider.crt
    cert_name: "{{ ssl_cert_name | default(domain) }}"
    target_host: "{{ inventory_hostname }}"
    target_group: "{{ group_names[0] | default('default_group') }}"

  tasks:
    - name: Verificar si el módulo ssl ya está habilitado
      command: httpd -t -D DUMP_MODULES | grep ssl
      register: ssl_module_status
      ignore_errors: yes
      changed_when: false
      tags:
        - ssl

    - name: Instalar mod_ssl si no está instalado
      ansible.builtin.dnf:
        name: mod_ssl
        state: present
      when: "'ssl_module' not in ssl_module_status.stdout"
      tags:
        - ssl

    - name: Crear directorio para certificados
      ansible.builtin.file:
        path: /etc/ssl/httpd
        state: directory
        owner: root
        group: root
        mode: '0755'
      tags:
        - ssl

    - name: Verificar si el enlace simbólico ssl.conf existe
      ansible.builtin.stat:
        path: /etc/httpd/conf.d/ssl.conf
      register: ssl_link_stat
      tags:
        - ssl

    - name: Crear enlace simbólico al módulo SSL (Red Hat)
      ansible.builtin.file:
        src: /etc/httpd/conf.modules.d/00-ssl.conf
        dest: /etc/httpd/conf.d/ssl.conf
        state: link
      notify:
        - Reiniciar Apache
      when: not ssl_link_stat.stat.exists
      tags:
        - ssl

    - name: Copiar certificado SSL al servidor
      ansible.builtin.copy:
        src: /opt/www/app/diaken-pdn/media/ssl/{{ cert_name }}/certificado.crt
        dest: /etc/ssl/httpd/{{ inventory_hostname }}.certificado.crt
        owner: root
        group: root
        mode: '0644'
      tags:
        - ssl

    - name: Copiar clave privada SSL al servidor
      ansible.builtin.copy:
        src: /opt/www/app/diaken-pdn/media/ssl/{{ cert_name }}/certificado.key
        dest: /etc/ssl/httpd/{{ inventory_hostname }}.certificado.key
        owner: root
        group: root
        mode: '0600'
      tags:
        - ssl

    - name: Copiar certificado provider SSL al servidor
      ansible.builtin.copy:
        src: /opt/www/app/diaken-pdn/media/ssl/{{ cert_name }}/certificado-provider.crt
        dest: /etc/ssl/httpd/{{ inventory_hostname }}-provider.crt
        owner: root
        group: root
        mode: '0644'
      tags:
        - ssl

    - name: Crear DocumentRoot del sitio
      ansible.builtin.file:
        path: "{{ server_root }}/{{ inventory_hostname }}"
        state: directory
        owner: apache
        group: apache
        mode: '0755'
      tags:
        - ssl

    - name: Configurar VirtualHost para HTTPS
      ansible.builtin.template:
        src: /opt/www/app/diaken-pdn/media/j2/group/virtualhost-ssl.conf.j2
        dest: /etc/httpd/conf.d/{{ inventory_hostname }}-ssl.conf
        owner: root
        group: root
        mode: '0644'
      notify:
        - Reiniciar Apache
      tags:
        - ssl

    - name: Configurar redirección HTTP a HTTPS
      ansible.builtin.template:
        src: /opt/www/app/diaken-pdn/media/j2/group/virtualhost-http-redirect.conf.j2
        dest: /etc/httpd/conf.d/{{ inventory_hostname }}-http-redirect.conf
        owner: root
        group: root
        mode: '0644'
      notify:
        - Reiniciar Apache
      tags:
        - ssl

    - name: Abrir puerto HTTPS en el firewall
      ansible.builtin.firewalld:
        port: "{{ https_port }}/tcp"
        permanent: yes
        state: enabled
        immediate: yes
      tags:
        - ssl

    - name: Recargar firewalld
      ansible.builtin.service:
        name: firewalld
        state: reloaded
      tags:
        - ssl

  handlers:
    - name: Reiniciar Apache
      ansible.builtin.service:
        name: httpd
        state: restarted
      tags:
        - ssl

  post_tasks:
    - name: Agregar mensaje SSL ok al index.html
      ansible.builtin.lineinfile:
        path: "{{ server_root }}/{{ target_host }}/index.html"
        line: '<div style="position: fixed; bottom: 10px; right: 10px; background: #4CAF50; color: white; padding: 10px; border-radius: 5px; font-family: Arial, sans-serif;">SSL OK</div>'
        insertafter: '</body>'
        backup: yes
      tags:
        - ssl

    - name: Mensaje de confirmación final
      ansible.builtin.debug:
        msg: >
          HTTPS habilitado en {{ inventory_hostname }} (grupo {{ target_group }}) en el puerto {{ https_port }}.
          Mensaje de confirmación SSL agregado a index.html.
