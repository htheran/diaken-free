# Apache2 Configuration for Debian/Ubuntu
# Generated by Ansible

# Global Configuration
ServerRoot "/etc/apache2"
Listen {{ debian_http_port }}

# User and Group
User {{ debian_apache_user }}
Group {{ debian_apache_group }}

# Server Admin
ServerAdmin root@localhost

# Security Settings
ServerTokens Prod
ServerSignature Off
TraceEnable Off
Timeout 60
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

# Restrict access to filesystem
<Directory />
    AllowOverride none
    Require all denied
    Options None
</Directory>

# Document Root
DocumentRoot "{{ debian_server_root }}/{{ inventory_hostname }}"

# Deny access to /var/www by default
<Directory "/var/www">
    AllowOverride None
    Require all denied
    Options None
</Directory>

# Site-specific configuration
<Directory "{{ debian_server_root }}/{{ inventory_hostname }}">
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted
    
    # Security Headers
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-Content-Type-Options "nosniff"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</Directory>

# Directory Index
<IfModule dir_module>
    DirectoryIndex index.html index.htm index.php
</IfModule>

# Deny access to .htaccess and similar files
<Files ~ "^\.ht">
    Require all denied
</Files>

# Deny access to backup and config files
<FilesMatch "(\.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)|~)$">
    Require all denied
</FilesMatch>

# Logging Configuration
ErrorLog "{{ debian_log_root }}/{{ inventory_hostname }}/error.log"
LogLevel warn

<IfModule log_config_module>
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
    LogFormat "%h %l %u %t \"%r\" %>s %b" common
    
    <IfModule logio_module>
        LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
    </IfModule>
    
    CustomLog "{{ debian_log_root }}/{{ inventory_hostname }}/access.log" combined
</IfModule>

# MIME Types
<IfModule mime_module>
    TypesConfig /etc/mime.types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
    AddType text/html .shtml
    AddOutputFilter INCLUDES .shtml
</IfModule>

# Default Charset
AddDefaultCharset UTF-8

# Enable Sendfile
EnableSendfile on

# Include module configurations
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf

# Include site configurations
IncludeOptional sites-enabled/*.conf
